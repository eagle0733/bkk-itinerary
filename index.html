<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>æ›¼è°·è¡Œç¨‹ï¼ˆç„¡é‡‘é‘°ãƒ»ç„¡å¤–éƒ¨JSï¼‰</title>
<meta name="theme-color" content="#0f172a" />
<style>
  :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --chip:#1f2937; --btn:#16a34a; }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif}
  .container{max-width:1100px;margin:0 auto;padding:16px 16px 96px}
  header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.75));backdrop-filter:blur(8px);border-bottom:1px solid rgba(148,163,184,.15)}
  .head-inner{display:flex;gap:12px;align-items:center;padding:12px 16px}
  .title{font-size:18px;font-weight:700}
  .sub{font-size:12px;color:var(--muted)}
  .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:8px 16px}
  .tab{padding:10px;border-radius:12px;background:var(--chip);color:var(--text);text-align:center;font-weight:700;border:1px solid rgba(255,255,255,.08);cursor:pointer}
  .tab[aria-selected="true"]{background:var(--btn);border-color:transparent}
  .controls{display:flex;gap:8px;flex-wrap:wrap;padding:8px 16px 12px}
  .select,.btn{border:none;border-radius:12px;padding:10px 12px;font-weight:600}
  .select{background:var(--chip);color:var(--text)}
  .btn{background:var(--btn);color:white;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;margin:10px 0}
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .time{font-weight:800;letter-spacing:.2px;min-width:86px}
  .place{font-weight:700}
  .note{color:var(--muted);font-size:12px;margin-top:4px}
  .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .action{flex:1;background:#0b5b2f;color:white;border-radius:12px;border:1px solid rgba(255,255,255,.12);padding:10px 12px;text-align:center;font-weight:700;cursor:pointer}
  .action.secondary{background:#0f766e}
  .route-card{background:#0b1220;border-radius:16px;border:1px dashed rgba(148,163,184,.25);padding:12px;margin-top:14px}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#0b1220;border:1px solid rgba(255,255,255,.1);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
  .grid{display:grid;gap:10px}
  @media (min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
  .mapbox{margin-top:14px;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.12)}
  iframe{width:100%;height:360px;border:0}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:70px;background:#0b1220;color:#e5e7eb;border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:12px;font-size:12px;display:none;z-index:120}
</style>
</head>
<body>
  <header>
    <div class="head-inner">
      <div>
        <div class="title">æ›¼è°·è¡Œç¨‹ï¼ˆç„¡é‡‘é‘°ãƒ»ç„¡å¤–éƒ¨JSï¼‰</div>
        <div class="sub">å¤–é–‹ Apple/Google/OSM å°èˆªï¼›å…§åµŒåœ°åœ–ä½¿ç”¨ Google-Embed æˆ– OSM-Embedï¼Œä¸éœ€ä»»ä½• API Key</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <select id="embedProvider" class="select" title="å…§åµŒåœ°åœ–ä¾†æº">
          <option value="google" selected>å…§åµŒï¼šGoogle</option>
          <option value="osm">å…§åµŒï¼šOSM</option>
        </select>
        <button class="btn ghost" id="btnInstall" title="åŠ å…¥ä¸»ç•«é¢">ğŸ“² å®‰è£</button>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="Days">
      <button class="tab" role="tab" id="tab-1" aria-controls="panel-1" aria-selected="true">Day 1ï½œ9/26 (äº”)</button>
      <button class="tab" role="tab" id="tab-2" aria-controls="panel-2" aria-selected="false">Day 2ï½œ9/27 (å…­)</button>
      <button class="tab" role="tab" id="tab-3" aria-controls="panel-3" aria-selected="false">Day 3ï½œ9/28 (æ—¥)</button>
      <button class="tab" role="tab" id="tab-4" aria-controls="panel-4" aria-selected="false">Day 4ï½œ9/29 (ä¸€)</button>
    </div>

    <div class="controls">
      <select id="travelMode" class="select" aria-label="å°èˆªæ¨¡å¼">
        <option value="walk">æ­¥è¡Œï¼ˆå¤–é–‹ï¼‰</option>
        <option value="drive">é–‹è»Šï¼ˆå¤–é–‹ï¼‰</option>
      </select>
      <button class="btn" id="btnLocate">ğŸ“ é¡¯ç¤ºç›®å‰ä½ç½®</button>
      <button class="btn" id="btnTodayRoute">ğŸ—ºï¸ å¾æˆ‘é€™è£¡ä¸²èµ·ä»Šæ—¥è·¯ç·š</button>
      <button class="btn ghost" id="btnAdd">ï¼‹æ–°å¢ç«™é»</button>
      <button class="btn ghost" id="btnDel">åˆªé™¤ç«™é»</button>
      <button class="btn ghost" id="btnShare">åˆ†äº«é€£çµ</button>
    </div>
  </header>

  <main class="container">
    <div id="panels"></div>
    <div class="mapbox" id="liveMap" hidden>
      <iframe id="mapFrame" loading="lazy" allowfullscreen referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>
  </main>

  <div class="toast" id="toast"></div>

<script>
/* ===== åŸºæœ¬è³‡æ–™ï¼ˆéæ¿¾ç´”äº¤é€šæ®µï¼‰ ===== */
const DEFAULT_DAYS = [
  { id:1,label:'Day 1ï½œ9/26 (äº”)',chips:['Asokï½œErawan','Chula','æŒ‰æ‘©'],stops:[
    {time:'13:00â€“14:00',title:'Terminal 21 è³¼ç‰©',q:'Terminal 21 Asok',note:''},
    {time:'14:30â€“15:00',title:'å››é¢ä½› åƒæ‹œ',q:'Erawan Shrine Bangkok',note:'å¯çŸ­æš«åƒè§€'},
    {time:'15:00â€“16:30',title:'æœ±æ‹‰éš†åŠŸå¤§å­¸ æ ¡åœ’å·¡ç¦®',q:'Chulalongkorn University',note:'æ ¡åœ’èµ°èµ°'},
    {time:'16:30â€“18:00',title:'Chula å•†åœˆï¼ˆç­é€šè·¯ / Jay Ohï¼‰',q:'Banthat Thong Road Bangkok',note:'å¯åƒ Jay Oh Chula'},
    {time:'18:00â€“19:30',title:'Big Cï¼æš¹ç¾…å»£å ´ é€›è¡—',q:'Big C Ratchadamri or Siam Square',note:''},
    {time:'20:00â€“21:30',title:'Massage@Le æŒ‰æ‘©',q:'Massage@Le Bangkok',note:'æ”¾é¬†'}
  ]},
  { id:2,label:'Day 2ï½œ9/27 (å…­)',chips:['èˆŠåŸå¯ºå»Ÿç¾¤','æ²³ç•”','ICONSIAM'],stops:[
    {time:'09:30â€“12:00',title:'å¤§çš‡å®®ï¼ç‰ä½›å¯ºï¼è‡¥ä½›å¯ºï¼ç‘ªå“ˆæ³°å¯º å·¡ç¦®',q:'Grand Palace Bangkok',note:'åŒå€æ­¥è¡Œå¯é”'},
    {time:'12:00â€“13:00',title:'Tha Maharaj ç”¨é¤ä¼‘æ¯',q:'Tha Maharaj',note:''},
    {time:'13:30â€“15:00',title:'è€ƒå±±è·¯ é–’æ™ƒï¼ˆç‰¹è‰²æ˜Ÿå·´å…‹ï¼‰',q:'Khaosan Road',note:''},
    {time:'16:00â€“17:00',title:'é„­ç‹å»Ÿï¼ˆç‹æœ—å¸‚å ´ï¼‰',q:'Wat Arun Ratchawararam',note:'å¯é †é€› Wang Lang Market'},
    {time:'18:00â€“19:30',title:'ICONSIAM é€›è¡—',q:'ICONSIAM',note:''},
    {time:'19:45â€“21:45',title:'ç™½è˜­èŠ±è™Ÿ æ™šé¤éŠèˆ¹',q:'White Orchid River Cruise Bangkok',note:''}
  ]},
  { id:3,label:'Day 3ï½œ9/28 (æ—¥)',chips:['éƒŠå€åŒ…è»Š','å¸‚é›†','Spa'],stops:[
    {time:'07:00â€“13:30',title:'ä¸¹å«©æ²™æœµï¼ç¾åŠŸéµé“ï¼æ¨¹ä¸­å»Ÿï¼ˆåŒ…è»Šï¼‰',q:'Damnoen Saduak Floating Market',note:'å« Maeklong Railway Marketã€Wat Bang Kung'},
    {time:'15:00â€“17:00',title:'æ´½åœ–æ´½å¸‚é›†ï¼ˆJJ Mallï¼‰',q:'Chatuchak Weekend Market',note:''},
    {time:'17:00â€“18:20',title:'å–¬å¾·å¤œå¸‚ï¼ˆç«å±±æ’éª¨ï¼‰',q:'Jodd Fairs Rama 9 Bangkok',note:''},
    {time:'19:00â€“21:00',title:'Oasis æ°´ç™‚æŒ‰æ‘©',q:'Oasis Spa Bangkok',note:'å°±è¿‘åˆ†åº—'}
  ]},
  { id:4,label:'Day 4ï½œ9/29 (ä¸€)',chips:['Buffet','Siam å€'],stops:[
    {time:'10:00â€“12:00',title:'æš¹ç¾…ç™¾éº—å®® Buffetï¼ˆWISDOMï¼‰',q:'Siam Paragon',note:'WISDOM International Buffet'},
    {time:'12:00â€“14:00',title:'Big Cï¼æš¹ç¾…å»£å ´ é€›è¡—',q:'Big C Ratchadamri or Siam Square',note:''}
  ]}
];

const LS_KEY='itinerary_embed_noapi_v1';
(function(){const qs=new URLSearchParams(location.search);if(qs.get('reset')==='1')localStorage.removeItem(LS_KEY);})();
function ensureValidDays(d){if(!Array.isArray(d)||!d.length)return null;for(const x of d){if(!x||!('id'in x)||!Array.isArray(x.stops))return null;}return d;}
function loadRaw(){try{const r=localStorage.getItem(LS_KEY);return r?JSON.parse(r):null;}catch{return null}}
function save(){localStorage.setItem(LS_KEY,JSON.stringify(days));}
(function tryImportFromURL(){
  const qs=new URLSearchParams(location.search);let e=qs.get('data');if(!e&&location.hash.startsWith('#d='))e=location.hash.slice(3);
  if(!e)return;try{const json=decodeURIComponent(escape(atob(e)));const data=JSON.parse(json);
  if(Array.isArray(data)&&data.length){localStorage.setItem(LS_KEY,JSON.stringify(data));history.replaceState(null,'',location.pathname);location.reload();}}catch{}
})();
let days=ensureValidDays(loadRaw())||JSON.parse(JSON.stringify(DEFAULT_DAYS));save();

/* ===== UI ===== */
const panels=document.getElementById('panels');
const toast=document.getElementById('toast');
function showToast(m){toast.textContent=m;toast.style.display='block';setTimeout(()=>toast.style.display='none',2200);}
function encodeQ(q){return encodeURIComponent(q||'');}

function placeRow(stop){
  const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeQ(stop.q)}`;
  return `
  <div class="card">
    <div class="row"><div class="time">${stop.time||''}</div><div class="place">${stop.title||''}</div></div>
    ${stop.note?`<div class="note">${stop.note}</div>`:''}
    <div class="actions">
      <a class="action" target="_blank" rel="noopener" href="${mapUrl}">ğŸ—ºï¸ åœ°é»åœ°åœ–</a>
      <button class="action secondary" data-dest="${encodeQ(stop.q)}">â¡ï¸ ç”±æ­¤å°èˆª</button>
    </div>
  </div>`;
}

function renderPanels(){
  panels.innerHTML='';
  days.forEach(d=>{
    const chips=(d.chips||[]).map(c=>`<span class="pill">${c}</span>`).join(' ');
    const rows=(d.stops||[]).map(placeRow).join('');
    const sec=document.createElement('section');
    sec.id=`panel-${d.id}`;sec.setAttribute('role','tabpanel');sec.hidden=d.id!==1;
    sec.innerHTML=`
      <div class="card">
        <div class="row"><div style="font-size:18px;font-weight:800">${d.label}</div><div>${chips}</div></div>
        <div class="note">å¤–é–‹å°èˆªï¼šiOSâ†’Appleã€Androidâ†’Googleã€å…¶ä»–â†’OSMï¼›å…§åµŒåœ°åœ–åƒ…ä½œåƒè€ƒé¡¯ç¤ºã€‚</div>
      </div>
      <div class="grid">${rows}</div>
      <div class="route-card">
        <div style="font-weight:800;margin-bottom:8px">ğŸ“ ä¸€éµä¸²èµ·ä»Šæ—¥è·¯ç·šï¼ˆå¤–é–‹ï¼‰</div>
        <div class="actions">
          <button class="action" data-day="${d.id}" data-mode="full">ä¾åºé€ è¨ªå„ç«™</button>
          <button class="action secondary" data-day="${d.id}" data-mode="dest">åƒ…å°èˆªè‡³æœ€çµ‚é»</button>
        </div>
      </div>`;
    panels.appendChild(sec);
  });
}
renderPanels();

/* ===== å…§åµŒåœ°åœ–ï¼ˆç„¡ APIï¼‰ï¼šGoogle-Embed æˆ– OSM-Embed ===== */
const liveMap=document.getElementById('liveMap');
const mapFrame=document.getElementById('mapFrame');
function isSecureContext(){return location.protocol==='https:'||location.hostname==='localhost';}
function embedGoogleByLatLng(lat,lng,zoom=15){
  return `https://www.google.com/maps?q=${lat},${lng}&z=${zoom}&hl=zh-TW&output=embed`;
}
function embedOSMByLatLng(lat,lng,zoom=15){
  const d=0.02*(15/zoom); // ç²—ç•¥ bbox
  const west=lng-d,east=lng+d,south=lat-d,north=lat+d;
  return `https://www.openstreetmap.org/export/embed.html?bbox=${west},${south},${east},${north}&layer=mapnik&marker=${lat},${lng}`;
}

/* å®šä½èˆ‡å¤–é–‹å°èˆª */
const FALLBACK_ORIGIN='Samala Hotel Bangkok';
function getMode(){return document.getElementById('travelMode').value||'drive';}
function detectPlatform(){
  const ua=navigator.userAgent;
  return {ios:/iPad|iPhone|iPod/.test(ua), android:/Android/.test(ua)};
}
function externalNavURL(originLL, destQ, waypoints, mode){
  const saddr=`${originLL[0]},${originLL[1]}`;
  const {ios,android}=detectPlatform();
  if(ios){
    const travel=mode==='walk'?'w':'d';
    const wp=waypoints&&waypoints.length?`&q=${encodeURIComponent(waypoints.join(' to '))}`:'';
    return `https://maps.apple.com/?saddr=${encodeURIComponent(saddr)}&daddr=${encodeURIComponent(destQ)}&dirflg=${travel}${wp}`;
  }else if(android){
    const tm=mode==='walk'?'walking':'driving';
    const wp=waypoints&&waypoints.length?`&waypoints=${encodeURIComponent(waypoints.join('|'))}`:'';
    return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(saddr)}&destination=${encodeURIComponent(destQ)}${wp}&travelmode=${tm}`;
  }else{
    const tm=mode==='walk'?'foot':'car';
    const points=[saddr].concat(waypoints||[],[destQ]);
    return `https://www.openstreetmap.org/directions?engine=fossgis_osrm_${tm}&route=${encodeURIComponent(points.join(';'))}`;
  }
}

function getCurrentPosition(){
  return new Promise((resolve,reject)=>{
    if(!('geolocation' in navigator))return reject(new Error('NO_GEO'));
    navigator.geolocation.getCurrentPosition(
      pos=>resolve([pos.coords.latitude,pos.coords.longitude]),
      err=>reject(err),
      {enableHighAccuracy:true,timeout:12000,maximumAge:0}
    );
  });
}

async function resolveOriginLL(){
  if(!isSecureContext()) return null; // å¾ˆå¤šç€è¦½å™¨æœƒæ“‹ http çš„ geolocation
  try{
    const ll=await getCurrentPosition();
    localStorage.setItem('lastOrigin', ll.join(','));
    return ll;
  }catch(e){ return null; }
}

document.getElementById('btnLocate').addEventListener('click', async ()=>{
  const provider=document.getElementById('embedProvider').value;
  const last=localStorage.getItem('lastOrigin');
  let ll = last? last.split(',').map(Number): null;
  if(!ll) ll = await resolveOriginLL();
  if(!ll){ showToast('ç„¡æ³•å–å¾—å®šä½ï¼Œå°‡é¡¯ç¤ºé£¯åº—ä½ç½®'); ll=[13.737,100.553]; } // Samala é™„è¿‘å¤§è‡´åº§æ¨™
  const src = provider==='google' ? embedGoogleByLatLng(ll[0],ll[1],15) : embedOSMByLatLng(ll[0],ll[1],15);
  mapFrame.src=src; liveMap.hidden=false;
});

document.getElementById('btnTodayRoute').addEventListener('click', async ()=>{
  const current=document.querySelector('[role="tabpanel"]:not([hidden])');
  if(!current)return;
  const id=Number(current.id.split('-')[1]);
  const d=days.find(x=>x.id===id); if(!d)return;
  const mode=getMode();
  const last=localStorage.getItem('lastOrigin');
  let ll = last? last.split(',').map(Number): await resolveOriginLL();
  if(!ll){ showToast('ç”¨é£¯åº—ç•¶èµ·é»'); ll=[13.737,100.553];}
  const dest=d.stops[d.stops.length-1]?.q||'';
  const wp=d.stops.slice(0,-1).map(s=>s.q);
  const url=externalNavURL(ll, dest, wp, mode);
  const w=window.open(url,'_blank'); if(!w)location.href=url;
});

document.addEventListener('click',(e)=>{
  if(e.target.matches('.tab')){
    const id=Number(e.target.id.split('-')[1]);
    document.querySelectorAll('[role="tabpanel"]').forEach(p=>p.hidden=true);
    document.getElementById(`panel-${id}`).hidden=false;
    document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false'));
    e.target.setAttribute('aria-selected','true');
    window.scrollTo({top:0,behavior:'smooth'});
  }
  if(e.target.matches('.action.secondary')&&e.target.dataset.dest){
    const q=decodeURIComponent(e.target.dataset.dest);
    const mode=getMode();
    const last=localStorage.getItem('lastOrigin');
    if(!last){ showToast('å°šç„¡å®šä½ï¼Œå…ˆæŒ‰ã€Œé¡¯ç¤ºç›®å‰ä½ç½®ã€æœƒæ›´æº–'); }
    const ll = last? last.split(',').map(Number): [13.737,100.553];
    const url=externalNavURL(ll, q, [], mode);
    const w=window.open(url,'_blank'); if(!w)location.href=url;
  }
});

/* ===== æ–°å¢/åˆªé™¤/åˆ†äº« ===== */
document.getElementById('btnAdd').addEventListener('click',()=>{
  const dayId=Number(prompt('æ–°å¢åˆ°ç¬¬å¹¾å¤©ï¼ˆ1-4ï¼‰ï¼Ÿ')); if(!dayId)return;
  const time=prompt('æ™‚é–“ï¼ˆå¦‚ 14:00â€“16:00 æˆ– ä¸‹åˆï¼‰')||'';
  const title=prompt('æ¨™é¡Œï¼ˆé¡¯ç¤ºç”¨ï¼‰')||'æœªå‘½å';
  const q=prompt('å°èˆªé—œéµå­—ï¼ˆå¯ç”¨åœ°åæˆ–ç¶“ç·¯åº¦ï¼‰')||'';
  const note=prompt('å‚™è¨»ï¼ˆå¯ç•™ç©ºï¼‰')||'';
  const d=days.find(x=>x.id===dayId); if(!d)return alert('æ‰¾ä¸åˆ°æŒ‡å®šå¤©æ•¸');
  d.stops.push({time,title,q,note}); save(); renderPanels(); showToast('å·²æ–°å¢ç«™é»');
});
document.getElementById('btnDel').addEventListener('click',()=>{
  const dayId=Number(prompt('è¦åˆªé™¤å“ªä¸€å¤©ï¼ˆ1-4ï¼‰ï¼Ÿ')); const idx=Number(prompt('åˆªé™¤è©²æ—¥ç¬¬å¹¾å€‹ç«™é»ï¼ˆå¾ 1 èµ·ç®—ï¼‰ï¼Ÿ'));
  if(!dayId||!idx)return;
  const d=days.find(x=>x.id===dayId); if(!d||!d.stops[idx-1])return alert('æ‰¾ä¸åˆ°ç«™é»');
  d.stops.splice(idx-1,1); save(); renderPanels(); showToast('å·²åˆªé™¤ç«™é»');
});
function makeShareLink(){
  const json=JSON.stringify(days); const b64=btoa(unescape(encodeURIComponent(json)));
  const urlQ=`${location.origin}${location.pathname}?reset=1&v=${Date.now()}&data=${b64}`;
  return urlQ.length<1800 ? urlQ : `${location.origin}${location.pathname}#d=${b64}`;
}
document.getElementById('btnShare').addEventListener('click',async()=>{
  const url=makeShareLink();
  try{ if(navigator.share){ await navigator.share({title:'è¡Œç¨‹é€£çµ',url}); }
       else if(navigator.clipboard){ await navigator.clipboard.writeText(url); showToast('å·²è¤‡è£½åˆ†äº«é€£çµ'); }
       else { prompt('è¤‡è£½é€™å€‹é€£çµåˆ†äº«ï¼š',url); }
  }catch{ prompt('è¤‡è£½é€™å€‹é€£çµåˆ†äº«ï¼š',url); }
});

/* ===== PWAï¼ˆå¯é¸ï¼šéƒ¨åˆ†ç€è¦½å™¨æœƒé¡¯ç¤ºåŠ å…¥ä¸»ç•«é¢ï¼‰ ===== */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', (e)=>{e.preventDefault();deferredPrompt=e;});
document.getElementById('btnInstall').addEventListener('click',async()=>{
  if(!deferredPrompt) return alert('æ­¤ç€è¦½å™¨æš«ä¸æ”¯æ´å®‰è£æç¤ºï¼Œå¯ç”¨ç€è¦½å™¨ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ã€‚');
  deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null;
});
</script>
</body>
</html>
