<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="theme-color" content="#16a34a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <title>æ›¼è°·è¡Œç¨‹ï¼ˆå…§åµŒå°èˆª v2.2ï½œPWAï¼‰</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --chip:#1f2937; --btn:#16a34a; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif}
    .container{max-width:960px;margin:0 auto;padding:16px 16px 88px}
    header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.75));backdrop-filter: blur(8px);border-bottom:1px solid rgba(148,163,184,.15)}
    .head-inner{display:flex;gap:12px;align-items:center;padding:12px 16px}
    .title{font-size:18px;font-weight:700}
    .sub{font-size:12px;color:var(--muted)}
    .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:8px 16px}
    .tab{padding:10px;border-radius:12px;background:var(--chip);color:var(--text);text-align:center;font-weight:700;border:1px solid rgba(255,255,255,.08);cursor:pointer}
    .tab[aria-selected="true"]{background:var(--btn);border-color:transparent}
    .controls{display:flex;gap:8px;flex-wrap:wrap;padding:8px 16px 12px}
    .select,.btn{border:none;border-radius:12px;padding:10px 12px;font-weight:600}
    .select{background:var(--chip);color:var(--text)}
    .btn{background:var(--btn);color:white;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;margin:10px 0}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .time{font-weight:800;letter-spacing:.2px;min-width:86px}
    .place{font-weight:700}
    .note{color:var(--muted);font-size:12px;margin-top:4px}
    .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .action{flex:1;background:#0b5b2f;color:white;border-radius:12px;border:1px solid rgba(255,255,255,.12);padding:10px 12px;text-align:center;font-weight:700;cursor:pointer}
    .action.secondary{background:#0f766e}
    .route-card{background:#0b1220;border-radius:16px;border:1px dashed rgba(148,163,184,.25);padding:12px;margin-top:14px}
    .mapbox{margin-top:14px;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.12)}
    iframe{width:100%;height:280px;border:0}
    footer.nav{position:fixed;bottom:8px;left:0;right:0;display:flex;gap:8px;justify-content:center}
    .nav-inner{max-width:960px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:8px}
    .nav-btn{background:var(--chip);color:var(--text);border:1px solid rgba(255,255,255,.08);padding:10px 12px;border-radius:14px;text-align:center;font-weight:800;cursor:pointer}
    .nav-btn[aria-current="page"]{background:var(--btn);color:white}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#0b1220;border:1px solid rgba(255,255,255,.1);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .grid{display:grid;gap:10px}
    @media (min-width:720px){ .grid{grid-template-columns:1fr 1fr} iframe{height:360px} }
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:100}
    .sheet{position:fixed;left:50%;transform:translateX(-50%);bottom:0;background:#0b1220;border-top-left-radius:16px;border-top-right-radius:16px;width:min(960px,100%);max-height:78vh;display:flex;flex-direction:column;border:1px solid rgba(255,255,255,.12)}
    .sheet-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.12)}
    .sheet-title{font-weight:800}
    #map{height:56vh}
    .sheet-actions{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,.12)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:70px;background:#0b1220;color:#e5e7eb;border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:12px;font-size:12px;display:none;z-index:120}
  </style>
</head>
<body>
  <header>
    <div class="head-inner">
      <div>
        <div class="title">æ›¼è°·è¡Œç¨‹ï¼ˆå…§åµŒå°èˆª v2.2ï½œPWAï¼‰</div>
        <div class="sub">æ­¥è¡Œ/é–‹è»Šï¼šå…§åµŒå³æ™‚å°èˆªï¼›å¤§çœ¾é‹è¼¸ï¼šé–‹å•Ÿ Google åœ°åœ–ï¼›æ”¯æ´åˆ†äº«é€£çµåŒæ­¥</div>
      </div>
    </div>
    <div class="tabs" role="tablist" aria-label="Days">
      <button class="tab" role="tab" id="tab-1" aria-controls="panel-1" aria-selected="true">Day 1</button>
      <button class="tab" role="tab" id="tab-2" aria-controls="panel-2" aria-selected="false">Day 2</button>
      <button class="tab" role="tab" id="tab-3" aria-controls="panel-3" aria-selected="false">Day 3</button>
      <button class="tab" role="tab" id="tab-4" aria-controls="panel-4" aria-selected="false">Day 4</button>
    </div>
    <div class="controls">
      <select id="travelMode" class="select" aria-label="å°èˆªæ¨¡å¼">
        <option value="transit">å¤§çœ¾é‹è¼¸ï¼ˆå¤–é–‹ï¼‰</option>
        <option value="walking">æ­¥è¡Œï¼ˆå…§åµŒï¼‰</option>
        <option value="driving">è‡ªé§• / è¨ˆç¨‹è»Šï¼ˆå…§åµŒï¼‰</option>
      </select>
      <button class="btn" id="btnLocate">ğŸ“ é¡¯ç¤ºç›®å‰ä½ç½®</button>
      <button class="btn" id="btnTodayRoute">ğŸ—ºï¸ å¾æˆ‘é€™è£¡ä¸²èµ·ä»Šæ—¥è·¯ç·š</button>
      <button class="btn ghost" id="btnManage">ğŸ§© ç®¡ç†è¡Œç¨‹</button>
      <button class="btn" id="btnInstall" hidden>â• å®‰è£</button>
    </div>
  </header>

  <main class="container">
    <div id="panels"></div>
    <div class="mapbox" id="liveMap" hidden>
      <iframe id="mapFrame" loading="lazy" allowfullscreen referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>
  </main>

  <footer class="nav">
    <div class="nav-inner">
      <button class="nav-btn" data-go="1" aria-current="page">Day 1</button>
      <button class="nav-btn" data-go="2">Day 2</button>
      <button class="nav-btn" data-go="3">Day 3</button>
      <button class="nav-btn" data-go="4">Day 4</button>
    </div>
  </footer>

  <!-- å…§åµŒå°èˆªé¢æ¿ -->
  <div class="overlay" id="overlay">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheet-head">
        <div class="sheet-title">å…§åµŒå°èˆª</div>
        <div>
          <button class="btn ghost" id="btnOpenExternal">åœ¨ Google åœ°åœ–é–‹å•Ÿ</button>
          <button class="btn" id="btnClose">é—œé–‰</button>
        </div>
      </div>
      <div id="map"></div>
      <div class="sheet-actions" style="justify-content:space-between;">
        <div id="navStatus" style="font-size:12px;color:#94a3b8">æº–å‚™ä¸­â€¦</div>
        <div>
          <button class="btn ghost" id="btnFollow">ğŸ”” é–‹å§‹å³æ™‚å°èˆª</button>
          <button class="btn ghost" id="btnWake" title="ä¿æŒè¢å¹•å¸¸äº®">ğŸ’¡ å¸¸äº®</button>
          <button class="btn ghost" id="btnVoice" title="èªéŸ³æç¤º">ğŸ”ˆ èªéŸ³</button>
        </div>
      </div>
    </div>
  </div>

  <!-- è¡Œç¨‹ç®¡ç†é¢æ¿ -->
  <div class="overlay" id="mgrOverlay">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheet-head">
        <div class="sheet-title">ç®¡ç†è¡Œç¨‹</div>
        <div>
          <button class="btn ghost" id="btnAddStop">ï¼‹ æ–°å¢ç«™é»</button>
          <button class="btn ghost" id="btnShare">åˆ†äº«é€£çµ</button>
          <button class="btn ghost" id="btnExport">åŒ¯å‡ºJSON</button>
          <button class="btn ghost" id="btnImport">åŒ¯å…¥JSON</button>
          <button class="btn ghost" id="btnReset">é‡è¨­ç‚ºé è¨­</button>
          <button class="btn" id="btnCloseMgr">é—œé–‰</button>
        </div>
      </div>
      <div id="mgrBody" style="padding:10px;overflow:auto;max-height:60vh"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
  /* ========= PWAï¼ˆå®‰è£ï¼‹SW è¨»å†Šï¼‰ ========= */
  let deferredPrompt;
  const installBtn=document.getElementById('btnInstall');
  window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;installBtn.hidden=false;});
  installBtn?.addEventListener('click',async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;installBtn.hidden=true;});
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(console.warn); }

  /* ========= è¡Œç¨‹è³‡æ–™ ========= */
  const DEFAULT_DAYS = [
    {"id":1,"label":"Day 1ï½œ9/26 (äº”) ","chips":["æŠµé”æ—¥","Siam å€","æ”¾é¬†æŒ‰æ‘©"],
     "stops":[
       {"time":"07:55â€“10:40","title":"å°åŒ— â†’ æ›¼è°·","q":"Bangkok Suvarnabhumi Airport (BKK)","note":"èˆªç­æŠµé”"},
       {"time":"12:00â€“13:00","title":"Samala Hotel","q":"Samala Hotel Bangkok","note":"Check-in/å¯„æ”¾è¡Œæ"},
       {"time":"13:00â€“13:30","title":"æš¹ç¾…ç™¾éº—å®® Siam Paragon","q":"Siam Paragon","note":""},
       {"time":"13:30â€“15:00","title":"æš¹ç¾…æµ·æ´‹ä¸–ç•Œ Sea Life","q":"SEA LIFE Bangkok Ocean World","note":""},
       {"time":"15:00â€“16:00","title":"æœ±æ‹‰éš†åŠŸå¤§å­¸ æ ¡åœ’å·¡ç¦®","q":"Chulalongkorn University","note":"å­¸ç”Ÿå¸‚é›†ã€æ›¸åº—"},
       {"time":"16:00â€“17:30","title":"æœ±æ‹‰éš†åŠŸå•†åœˆï¼ˆç±³å…¶æ—é¤å»³ï¼‰","q":"Samyan Mitrtown food Michelin Bangkok","note":"å¯é¸ Samyan, CU å‘¨é‚Š"},
       {"time":"17:30â€“19:30","title":"Big C / æš¹ç¾…å»£å ´é€›è¡—","q":"Big C Ratchadamri or Siam Square","note":""},
       {"time":"19:30â†’","title":"è¿”å› Samalaï¼ˆMassage@Leï¼‰","q":"Massage@Le Bangkok","note":"å¯è€ƒï¼šNana Plazaï¼ˆæˆäººæ™¯é»ï¼‰"}
     ]},
    {"id":2,"label":"Day 2ï½œ9/27 (å…­) ","chips":["å¸‚é›†æ—¥","JJ Mall","å¤œå¸‚ç¾é£Ÿ"],
     "stops":[
       {"time":"08:30â€“09:30","title":"æ´½åœ–æ´½å¸‚é›† Chatuchak","q":"Chatuchak Weekend Market","note":""},
       {"time":"09:30â€“11:30","title":"JJ Mall é–’é€›","q":"JJ Mall Bangkok","note":""},
       {"time":"11:30â€“12:30","title":"åˆé¤ï¼ˆè‡ªç”±å®‰æ’ï¼‰","q":"Chatuchak food court","note":""},
       {"time":"17:30â€“19:30","title":"å–¬å¾·å¤œå¸‚ Jodd Fairsï¼ˆç«å±±æ’éª¨ï¼‰","q":"Jodd Fairs Rama 9 Bangkok","note":"äººæ°£å¤œå¸‚"}
     ]},
    {"id":3,"label":"Day 3ï½œ9/28 (æ—¥) ","chips":["æ²³ä¸Šäº¤é€š","å¯ºå»Ÿç¾¤","è€ƒå±±è·¯"],
     "stops":[
       {"time":"07:00â€“08:30","title":"è¬è±ªé™„è¿‘æ—©å¸‚","q":"Morning Market near Bangkok Marriott","note":"ä¾ä½å®¿é»å°±è¿‘æ—©å¸‚"},
       {"time":"08:30â€“09:00","title":"Sathorn Pier ä¸­å¤®ç¢¼é ­","q":"Sathorn Pier (Central Pier)","note":"æ­èˆ¹å‡ºç™¼"},
       {"time":"09:00â€“09:30","title":"Rajinee ç¢¼é ­","q":"Rajinee Pier Bangkok","note":"æ­¥è¡Œå‰å¾€å¯ºå»Ÿç¾¤"},
       {"time":"09:30â€“12:00","title":"å¤§çš‡å®® / ç‰ä½›å¯º / è‡¥ä½›å¯º","q":"Grand Palace Bangkok","note":"åŒå€åŸŸæ­¥è¡Œå¯é”"},
       {"time":"12:00â€“13:30","title":"ç‘ªå“ˆæ³°æ–‡é’å¸‚é›† ç”¨é¤","q":"Tha Maharaj","note":""},
       {"time":"13:30â€“14:30","title":"ç‹æœ—å¸‚å ´ â†’ é„­ç‹å»Ÿ","q":"Wang Lang Market","note":"å¯æ­èˆ¹éæ²³åˆ° Wat Arun"},
       {"time":"14:30â€“15:30","title":"é„­ç‹å»Ÿ Wat Arun","q":"Wat Arun Ratchawararam","note":""},
       {"time":"15:30â€“17:00","title":"å‰å¾€è€ƒå±±è·¯ & ç‰¹è‰²é»","q":"Khaosan Road","note":"å¯çœ‹è—æ˜Ÿå·´å…‹/å ¡å£˜ç­‰"},
       {"time":"19:00â†’","title":"è¿”å› Samalaï¼ˆæŒ‰æ‘©ï¼‰","q":"Samala Hotel Bangkok","note":""}
     ]},
    {"id":4,"label":"Day 4ï½œ9/29 (ä¸€) ","chips":["åœ¨åœ°å¸‚å ´","æ²³ç•”å•†å ´"],
     "stops":[
       {"time":"08:30â€“09:30","title":"ç©ºå»å¸‚å ´ Khlong Toei Market","q":"Khlong Toei Market","note":"éœ€æœ‰å¿ƒç†æº–å‚™ï¼"},
       {"time":"09:45â€“10:30","title":"Suan Phlu Market","q":"Suan Phlu Market","note":""},
       {"time":"10:45â€“11:30","title":"Bang Rak Bazaar","q":"Bang Rak Bazaar","note":""},
       {"time":"ä¸‹åˆ","title":"ICONSIAMï¼ˆé¦–é¸ï¼‰ / Big C","q":"ICONSIAM","note":"å¯è‡ªç”±è³¼ç‰©/ç”¨é¤"}
     ]}
  ];

  /* ========= æŒä¹…åŒ–ï¼‹åˆ†äº«åŒ¯å…¥ï¼ˆå¼·åŒ–ç‰ˆï¼‰ ========= */
  const LS_KEY='itinerary_v1';

  // ?reset=1 â†’ å…ˆæ¸…é™¤èˆŠè³‡æ–™
  (function checkReset(){
    const sp = new URLSearchParams(location.search);
    if (sp.get('reset') === '1') localStorage.removeItem(LS_KEY);
  })();

  // å£è³‡æ–™ä¿è­·
  function ensureValidDays(d){
    if(!Array.isArray(d) || d.length===0) return null;
    for(const day of d){
      if(!day || typeof day!=='object') return null;
      if(!('id' in day) || !Array.isArray(day.stops)) return null;
    }
    return d;
  }
  function loadDaysRaw(){ try{ const raw=localStorage.getItem(LS_KEY); return raw?JSON.parse(raw):null; }catch{ return null; } }
  function saveDays(){ localStorage.setItem(LS_KEY, JSON.stringify(days)); }

  // å¾ ?data= æˆ– #d= åŒ¯å…¥
  function tryImportFromURL() {
    const parseOnce = () => {
      const qs = new URLSearchParams(location.search);
      let encoded = qs.get('data');
      if (!encoded && location.hash.startsWith('#d=')) encoded = location.hash.slice(3);
      if (!encoded) return false;
      try{
        const json = decodeURIComponent(escape(atob(encoded)));
        const data = JSON.parse(json);
        if(Array.isArray(data) && data.length){
          localStorage.setItem(LS_KEY, JSON.stringify(data));
          history.replaceState(null,'',location.pathname);
          window.__importedFromURL = true;
          return true;
        }
      }catch(e){}
      return false;
    };
    if (parseOnce()) return;
    window.addEventListener('pageshow', ()=>{ if(parseOnce()) location.reload(); });
  }
  tryImportFromURL();

  // åˆå§‹åŒ– daysï¼ˆå«å›é€€ï¼‰
  let days = ensureValidDays(loadDaysRaw()) || JSON.parse(JSON.stringify(DEFAULT_DAYS));
  saveDays();

  /* ========= UI & åŠŸèƒ½ ========= */
  const FALLBACK_ORIGIN='Samala Hotel Bangkok';
  const panels=document.getElementById('panels');
  const toast=document.getElementById('toast');
  const state={ origin: localStorage.getItem('lastOrigin')||FALLBACK_ORIGIN, map:null, routeLayer:null, markers:[], userMarker:null, externalUrl:null };
  function showToast(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',2200); }
  function encodeQ(q){return encodeURIComponent(q||'');}
  function isSecureContext(){return location.protocol==='https:'||location.hostname==='localhost';}
  function getMode(){return document.getElementById('travelMode').value||'transit';}

  function placeRow(stop){
    const mapUrl=`https://www.google.com/maps/search/?api=1&query=${encodeQ(stop.q)}`;
    return `<div class="card">
      <div class="row"><div class="time">${stop.time||''}</div><div class="place">${stop.title||''}</div></div>
      ${stop.note?`<div class="note">${stop.note}</div>`:''}
      <div class="actions">
        <a class="action" target="_blank" rel="noopener" href="${mapUrl}">ğŸ—ºï¸ åœ°é»åœ°åœ–</a>
        <button class="action secondary" data-dest="${encodeQ(stop.q)}">â¡ï¸ ç”±æ­¤å°èˆª</button>
        <button class="action" data-dest-inline="${encodeQ(stop.q)}">ğŸ§­ å…§åµŒå°èˆª</button>
      </div>
    </div>`;
  }
  function renderPanels(){
    panels.innerHTML='';
    days.forEach(d=>{
      const chips=(d.chips||[]).map(c=>`<span class="pill">${c}</span>`).join(' ');
      const rows=(d.stops||[]).map(placeRow).join('');
      const panel=document.createElement('section');
      panel.id=`panel-${d.id}`;
      panel.setAttribute('role','tabpanel');
      panel.setAttribute('aria-labelledby',`tab-${d.id}`);
      panel.hidden=d.id!==1;
      panel.innerHTML=`
        <div class="card">
          <div class="row"><div style="font-size:18px;font-weight:800">${d.label||('Day '+d.id)}</div><div>${chips}</div></div>
          <div class="note">æ­¥è¡Œ/é–‹è»Š â‡’ å…§åµŒï¼›å¤§çœ¾é‹è¼¸ â‡’ Google åœ°åœ–ã€‚å¯ç”¨ã€ŒğŸ§© ç®¡ç†è¡Œç¨‹ã€æ–°å¢/åˆªé™¤/åˆ†äº«/åŒ¯å‡º/åŒ¯å…¥ã€‚</div>
        </div>
        <div class="grid">${rows}</div>
        <div class="route-card">
          <div style="font-weight:800;margin-bottom:8px">ğŸ“ ä¸€éµä¸²èµ·ä»Šæ—¥è·¯ç·š</div>
          <div class="actions">
            <button class="action" data-day="${d.id}" data-mode="full">å…§åµŒï¼šä¾åºé€ è¨ªå„ç«™ï¼ˆæ­¥è¡Œ/é–‹è»Šï¼‰</button>
            <button class="action secondary" data-day="${d.id}" data-mode="dest">åƒ…å°èˆªè‡³æœ€çµ‚é»</button>
          </div>
        </div>`;
      panels.appendChild(panel);
    });
  }
  function rerenderAndSave(){ renderPanels(); saveDays(); }

  // é€£çºŒå®šä½
  function startWatch(){
    if(!('geolocation' in navigator)){ showToast('è£ç½®ä¸æ”¯æ´å®šä½'); return; }
    navigator.geolocation.watchPosition(pos=>{
      state.origin=`${pos.coords.latitude},${pos.coords.longitude}`;
      localStorage.setItem('lastOrigin', state.origin);
      if(state.map){
        if(!state.userMarker) state.userMarker=L.marker([pos.coords.latitude,pos.coords.longitude]).addTo(state.map);
        else state.userMarker.setLatLng([pos.coords.latitude,pos.coords.longitude]);
      }
      tickLive([pos.coords.latitude,pos.coords.longitude]);
    }, console.warn, {enableHighAccuracy:true, timeout:12000, maximumAge:2000});
  }

  function buildDirURL(origin,destination,waypoints,mode){
    const base='https://www.google.com/maps/dir/?api=1';
    const o=`origin=${encodeURIComponent(origin)}`, d=`destination=${encodeURIComponent(destination)}`, m=`travelmode=${mode}`;
    const w=waypoints&&waypoints.length?`&waypoints=${waypoints.map(wp=>encodeURIComponent(wp)).join('|')}`:'';
    return `${base}&${o}&${d}${w}&${m}`;
  }
  function openExternal(url){const win=window.open(url,'_blank'); if(!win) location.href=url;}

  // å…§åµŒå°èˆªï¼ˆLeaflet + OSRMï¼‰
  const overlayEl=document.getElementById('overlay');
  const btnClose=document.getElementById('btnClose');
  const btnOpenExternal=document.getElementById('btnOpenExternal');
  const navStatus=document.getElementById('navStatus');
  let followOn=false,lastRerouteTs=0,currentRouteCoords=[],finalDestLL=null,currentDestQ=null,currentWpsQ=[],currentMode=null;
  const REROUTE_INTERVAL_MS=15000,OFFROUTE_THRESHOLD_M=80;
  function openSheet(){overlayEl.style.display='block'; if(!state.map) initMap();}
  function closeSheet(){overlayEl.style.display='none';}
  btnClose.addEventListener('click', closeSheet);
  btnOpenExternal.addEventListener('click', ()=>{ if(state.externalUrl) openExternal(state.externalUrl); });

  function initMap(){
    state.map=L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(state.map);
    state.map.setView([13.7563,100.5018],12);
  }
  async function geocode(q){
    const m=q && q.match?.(/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/);
    if(m) return [parseFloat(m[1]),parseFloat(m[2])];
    const key='gc_'+q; const cached=localStorage.getItem(key);
    if(cached){ try{ const v=JSON.parse(cached); if(Array.isArray(v)&&v.length===2) return v; }catch{} }
    const ctl=new AbortController(); const t=setTimeout(()=>ctl.abort(),8000);
    try{
      const r1=await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(q)}&lang=zh-TW`,{signal:ctl.signal});
      if(r1.ok){ const j=await r1.json(); if(j.features&&j.features[0]){ const [lng,lat]=j.features[0].geometry.coordinates; clearTimeout(t); localStorage.setItem(key,JSON.stringify([lat,lng])); return [lat,lng]; } }
    }catch{}
    try{
      const r2=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`,{headers:{'Accept':'application/json'},referrerPolicy:'no-referrer',signal:ctl.signal});
      if(r2.ok){ const j=await r2.json(); if(j&&j[0]){ clearTimeout(t); const lat=parseFloat(j[0].lat),lon=parseFloat(j[0].lon); localStorage.setItem(key,JSON.stringify([lat,lon])); return [lat,lon]; } }
    }catch{}
    clearTimeout(t); throw new Error('GEOCODE_FAIL');
  }
  async function osrmRoute(coords, profile){
    const pts=coords.map(([lat,lng])=>`${lng},${lat}`).join(';');
    const url=`https://router.project-osrm.org/route/v1/${profile}/${pts}?overview=full&geometries=geojson&steps=true`;
    const r=await fetch(url); const j=await r.json(); if(j.code!=='Ok') throw new Error('OSRM error'); return j.routes[0];
  }
  function clearRoute(){ if(state.routeLayer){state.map.removeLayer(state.routeLayer); state.routeLayer=null;} state.markers.forEach(m=>state.map.removeLayer(m)); state.markers=[]; }
  async function inlineNavigate(originQ,destQ,waypointsQ,mode){
    const profile=mode==='walking'?'foot':'driving';
    try{
      openSheet(); clearRoute();
      let originLL; try{ originLL=await geocode(originQ); }catch{ originLL=await geocode(FALLBACK_ORIGIN); }
      const wp=[]; for(const w of (waypointsQ||[])){ try{ wp.push(await geocode(w)); }catch{} }
      let destLL; try{ destLL=await geocode(destQ); }catch{ openExternal(buildDirURL(originQ,destQ,waypointsQ,mode)); return; }
      const all=[originLL,...wp,destLL]; if(all.length<2){ openExternal(buildDirURL(originQ,destQ,waypointsQ,mode)); return; }
      const route=await osrmRoute(all, profile);
      const line=L.geoJSON(route.geometry).addTo(state.map); state.routeLayer=line;
      state.map.fitBounds(line.getBounds(),{padding:[30,30]});
      state.externalUrl=buildDirURL(originQ,destQ,waypointsQ,mode==='walking'?'walking':'driving');
      setCurrentRoute(route,destLL); currentDestQ=destQ; currentWpsQ=waypointsQ||[]; currentMode=mode; lastRerouteTs=Date.now(); navStatus.textContent='è·¯ç·šå·²å»ºç«‹ï¼Œæ‚¨å¯ä»¥é–‹å§‹ç§»å‹•ã€‚';
    }catch{ openExternal(buildDirURL(originQ,destQ,waypointsQ,mode)); }
  }
  function setCurrentRoute(route,destLL){ currentRouteCoords=route.geometry.coordinates.map(([lng,lat])=>[lat,lng]); finalDestLL=destLL; }
  function toRad(x){return x*Math.PI/180;}
  function haversine(a,b){ const R=6371000; const dLat=toRad(b[0]-a[0]), dLon=toRad(b[1]-a[1]); const lat1=toRad(a[0]), lat2=toRad(b[0]); const h=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(h)); }
  function nearestDistanceToLine(point,line){ let min=Infinity; for(const p of line){ const d=haversine(point,p); if(d<min) min=d; } return min; }
  const btnFollow=document.getElementById('btnFollow'), btnWake=document.getElementById('btnWake'), btnVoice=document.getElementById('btnVoice');
  let wakeLockObj=null, voiceOn=false;
  async function requestWake(){ try{ wakeLockObj=await navigator.wakeLock.request('screen'); showToast('å·²å•Ÿç”¨å¸¸äº®'); }catch{ showToast('å¸¸äº®å•Ÿç”¨å¤±æ•—'); } }
  function releaseWake(){ try{ wakeLockObj&&wakeLockObj.release(); wakeLockObj=null; showToast('å·²é—œé–‰å¸¸äº®'); }catch{} }
  function speak(text){ if(!voiceOn) return; try{ const u=new SpeechSynthesisUtterance(text); u.lang='zh-TW'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }
  btnFollow.addEventListener('click',()=>{ followOn=!followOn; btnFollow.textContent=followOn?'ğŸ›‘ åœæ­¢å³æ™‚å°èˆª':'ğŸ”” é–‹å§‹å³æ™‚å°èˆª'; if(followOn){ speak('é–‹å§‹å³æ™‚å°èˆª'); navStatus.textContent='å³æ™‚å°èˆªå•Ÿå‹•ä¸­â€¦'; } else { navStatus.textContent='å·²åœæ­¢å³æ™‚å°èˆª'; } });
  btnWake.addEventListener('click',()=>{ if(!wakeLockObj) requestWake(); else releaseWake(); });
  btnVoice.addEventListener('click',()=>{ voiceOn=!voiceOn; btnVoice.textContent=voiceOn?'ğŸ”Š èªéŸ³é–‹':'ğŸ”ˆ èªéŸ³'; showToast(voiceOn?'å·²é–‹å•ŸèªéŸ³æç¤º':'å·²é—œé–‰èªéŸ³æç¤º'); });
  function tickLive(userLL){
    if(!followOn||!currentRouteCoords.length){ if(followOn&&state.externalUrl) navStatus.textContent='å·²å•Ÿå‹•ï¼Œç­‰å¾…è·¯ç·šâ€¦'; return; }
    const dist=haversine(userLL,finalDestLL); const off=nearestDistanceToLine(userLL,currentRouteCoords); const now=Date.now();
    if(off>OFFROUTE_THRESHOLD_M || (now-lastRerouteTs)>REROUTE_INTERVAL_MS){ lastRerouteTs=now; inlineNavigate(`${userLL[0]},${userLL[1]}`,currentDestQ,currentWpsQ,currentMode); speak('é‡æ–°è¦åŠƒè·¯ç·š'); }
    navStatus.textContent=`è·é›¢çµ‚é» ${(dist/1000).toFixed(2)} kmï½œåé›¢ ${Math.round(off)} m`;
  }

  // Live mapï¼ˆé è¦½ï¼‰
  const liveMap=document.getElementById('liveMap'), mapFrame=document.getElementById('mapFrame');
  document.getElementById('btnLocate').addEventListener('click',()=>{ const src=`https://www.google.com/maps?q=${encodeURIComponent(state.origin)}&z=15&hl=zh-TW&output=embed`; mapFrame.src=src; liveMap.hidden=false; });

  // é»æ“Š/åˆ‡æ›
  document.addEventListener('click',(e)=>{
    if(e.target.matches('.tab')){ const id=Number(e.target.id.split('-')[1]); showTab(id); window.scrollTo({top:0,behavior:'smooth'}); }
    if(e.target.matches('.nav-btn')){ showTab(Number(e.target.dataset.go)); window.scrollTo({top:0,behavior:'smooth'}); }
    if(e.target.matches('.action.secondary') && e.target.dataset.dest){
      const dest=decodeURIComponent(e.target.dataset.dest); const mode=getMode();
      if(mode==='transit') openExternal(buildDirURL(state.origin,dest,[],mode)); else inlineNavigate(state.origin,dest,[],mode);
    }
    if(e.target.matches('.action') && e.target.dataset.day){
      const id=Number(e.target.dataset.day), mode=e.target.dataset.mode; const d=days.find(x=>x.id===id); if(!d) return;
      const dest=d.stops[d.stops.length-1]?.q||''; const w=(mode==='dest')?[]:d.stops.slice(0,-1).map(s=>s.q); const travel=getMode();
      if(travel==='transit') openExternal(buildDirURL(state.origin,dest,w,travel)); else inlineNavigate(state.origin,dest,w,travel);
    }
    if(e.target.matches('[data-dest-inline]')){
      const dest=decodeURIComponent(e.target.dataset.destInline); const travel=getMode();
      if(travel==='transit') openExternal(buildDirURL(state.origin,dest,[],travel)); else inlineNavigate(state.origin,dest,[],travel);
    }
  });
  function showTab(id){
    document.querySelectorAll('[role="tabpanel"]').forEach(p=>p.hidden=true);
    document.getElementById(`panel-${id}`).hidden=false;
    document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false'));
    document.getElementById(`tab-${id}`).setAttribute('aria-selected','true');
    document.querySelectorAll('.nav-btn').forEach(n=>n.removeAttribute('aria-current'));
    document.querySelector(`.nav-btn[data-go="${id}"]`).setAttribute('aria-current','page');
  }
  document.getElementById('btnTodayRoute').addEventListener('click',()=>{
    const current=document.querySelector('[role="tabpanel"]:not([hidden])'); if(!current) return;
    const id=Number(current.id.split('-')[1]); const d=days.find(x=>x.id===id); if(!d) return;
    const dest=d.stops[d.stops.length-1]?.q||''; const way=d.stops.slice(0,-1).map(s=>s.q); const travel=getMode();
    if(travel==='transit') openExternal(buildDirURL(state.origin,dest,way,travel)); else inlineNavigate(state.origin,dest,way,travel);
  });

  // è¡Œç¨‹ç®¡ç†
  const mgrOverlay=document.getElementById('mgrOverlay'), mgrBody=document.getElementById('mgrBody');
  const btnManage=document.getElementById('btnManage'), btnCloseMgr=document.getElementById('btnCloseMgr');
  const btnAddStop=document.getElementById('btnAddStop'), btnShare=document.getElementById('btnShare');
  const btnExport=document.getElementById('btnExport'), btnImport=document.getElementById('btnImport'), btnReset=document.getElementById('btnReset');
  function openManager(){ renderManager(); mgrOverlay.style.display='block'; }
  function closeManager(){ mgrOverlay.style.display='none'; }
  btnManage.addEventListener('click', openManager); btnCloseMgr.addEventListener('click', closeManager);

  function renderManager(){
    let html='';
    days.forEach(d=>{
      html+=`<div class="card"><div class="row"><div style="font-weight:800">${d.label||('Day '+d.id)}</div>
        <div>${(d.chips||[]).map(c=>`<span class="pill">${c}</span>`).join(' ')}</div></div>
        <ul style="list-style:none;padding:0;margin:8px 0">
          ${(d.stops||[]).map((s,idx)=>`
            <li class="row" style="align-items:flex-start;gap:8px;margin:6px 0">
              <div class="time" style="min-width:96px">${s.time||''}</div>
              <div style="flex:1"><div class="place">${s.title||''}</div><div class="note">${s.q||''}${s.note?`ï½œ${s.note}`:''}</div></div>
              <button class="btn ghost" data-del="${d.id}:${idx}">åˆªé™¤</button>
            </li>
          `).join('')}
        </ul></div>`;
    });
    mgrBody.innerHTML=html;
  }
  document.addEventListener('click',(e)=>{
    if(e.target.matches('[data-del]')){
      const [dayIdStr,idxStr]=e.target.dataset.del.split(':');
      const d=days.find(x=>x.id===Number(dayIdStr)); if(!d) return;
      if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç«™é»ï¼Ÿ')) return;
      d.stops.splice(Number(idxStr),1);
      saveDays(); rerenderAndSave(); renderManager(); showToast('å·²åˆªé™¤ç«™é»');
    }
  });
  btnAddStop.addEventListener('click',()=>{
    const dayId=Number(prompt('è¦æ–°å¢åˆ°ç¬¬å¹¾å¤©ï¼Ÿ(1-4)')); if(!dayId) return;
    const time=prompt('æ™‚é–“ï¼ˆå¦‚ 14:00â€“16:00 æˆ– ä¸‹åˆï¼‰')||'';
    const title=prompt('æ¨™é¡Œï¼ˆé¡¯ç¤ºç”¨ï¼‰')||'æœªå‘½å';
    const q=prompt('å°èˆªé—œéµå­—æˆ–ç¶“ç·¯åº¦ï¼ˆå¦‚ "Siam Paragon" æˆ– "13.7467,100.5349"ï¼‰')||'';
    const note=prompt('å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰')||'';
    const d=days.find(x=>x.id===dayId); if(!d) return alert('æ‰¾ä¸åˆ°æŒ‡å®šå¤©æ•¸');
    d.stops.push({time,title,q,note});
    saveDays(); rerenderAndSave(); renderManager(); showToast('å·²æ–°å¢ç«™é»');
  });

  // åˆ†äº«é€£çµï¼ˆå« reset/vï¼›éé•·æ”¹ç”¨ #d=ï¼‰
  function makeShareLink() {
    const json=JSON.stringify(days);
    const b64=btoa(unescape(encodeURIComponent(json)));
    const urlQ=`${location.origin}${location.pathname}?reset=1&v=${Date.now()}&data=${b64}`;
    if(urlQ.length<1800) return urlQ;
    return `${location.origin}${location.pathname}#d=${b64}`;
  }
  btnShare.addEventListener('click',async()=>{
    const url=makeShareLink();
    try{
      if(navigator.share){ await navigator.share({title:'è¡Œç¨‹é€£çµ',url}); }
      else if(navigator.clipboard){ await navigator.clipboard.writeText(url); showToast('å·²è¤‡è£½åˆ†äº«é€£çµ'); }
      else { prompt('è¤‡è£½é€™å€‹é€£çµåˆ†äº«ï¼š',url); }
    }catch{ prompt('è¤‡è£½é€™å€‹é€£çµåˆ†äº«ï¼š',url); }
  });

  btnExport.addEventListener('click',()=>{ const blob=new Blob([JSON.stringify(days,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='itinerary.json'; a.click(); URL.revokeObjectURL(url); });
  btnImport.addEventListener('click',()=>{ const str=prompt('è²¼ä¸Š days é™£åˆ— JSON'); if(!str) return; try{ const incoming=JSON.parse(str); if(Array.isArray(incoming)){ localStorage.setItem(LS_KEY, JSON.stringify(incoming)); location.reload(); } else alert('æ ¼å¼éŒ¯èª¤ï¼šéœ€ç‚ºé™£åˆ—'); }catch{ alert('JSON è§£æå¤±æ•—'); } });
  btnReset.addEventListener('click',()=>{ if(!confirm('ç¢ºå®šå°‡è¡Œç¨‹é‡è¨­ç‚ºé è¨­å…§å®¹ï¼Ÿï¼ˆæœƒè¦†è“‹ç›®å‰çš„è‡ªè¨‚ï¼‰')) return; localStorage.removeItem(LS_KEY); location.reload(); });

  // åˆå§‹æ¸²æŸ“ & äº‹ä»¶
  renderPanels();
  if(window.__importedFromURL) showToast('å·²å¾åˆ†äº«é€£çµè¼‰å…¥è¡Œç¨‹');
  if(isSecureContext()) startWatch(); else showToast('å»ºè­°ä½¿ç”¨ HTTPS ç¶²å€ä»¥å•Ÿç”¨é€£çºŒå®šä½');

  // åŒè£ç½®ã€è·¨åˆ†é åŒæ­¥
  window.addEventListener('storage',(e)=>{ if(e.key===LS_KEY){ try{ const next=JSON.parse(e.newValue||'null'); if(Array.isArray(next)){ days=next; renderPanels(); } }catch{} }});
  </script>
</body>
</html>
