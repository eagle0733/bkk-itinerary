<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>æ›¼è°·è¡Œç¨‹ï½œå…§åµŒå°èˆªï¼ˆOSRM+Nominatimï¼Œç„¡é‡‘é‘°ï¼‰</title>
<meta name="theme-color" content="#0f172a"/>
<style>
:root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--chip:#1f2937;--btn:#16a34a;}
*{box-sizing:border-box}html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif}
header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(15,23,42,.98),rgba(15,23,42,.75));backdrop-filter:blur(8px);border-bottom:1px solid rgba(148,163,184,.15)}
.head{display:flex;gap:12px;align-items:center;padding:12px 16px}
.title{font-size:18px;font-weight:800}.sub{font-size:12px;color:var(--muted)}
.tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:8px 16px}
.tab{padding:10px;border-radius:12px;background:var(--chip);color:var(--text);text-align:center;font-weight:700;border:1px solid rgba(255,255,255,.08);cursor:pointer}
.tab[aria-selected="true"]{background:var(--btn);border-color:transparent}
.bar{display:flex;gap:8px;flex-wrap:wrap;padding:8px 16px}
.select,.btn{border:none;border-radius:12px;padding:10px 12px;font-weight:700}
.select{background:var(--chip);color:var(--text)}.btn{background:var(--btn);color:#fff;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.2);color:var(--text)}
.container{max-width:1180px;margin:0 auto;padding:16px 16px 96px}
.grid{display:grid;grid-template-columns:1fr 420px;gap:12px}@media(max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
.pill{display:inline-flex;align-items:center;gap:6px;background:#0b1220;border:1px solid rgba(255,255,255,.1);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
.row{display:flex;align-items:center;justify-content:space-between;gap:10px}.time{font-weight:800;min-width:90px}.place{font-weight:800}.note{font-size:12px;color:var(--muted);margin-top:4px}
.actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}.action{flex:1;background:#0b5b2f;color:#fff;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;text-align:center;font-weight:800;cursor:pointer}.secondary{background:#0f766e}
#map{height:56vh;border-radius:14px;border:1px solid rgba(255,255,255,.12)}#panel{height:56vh;overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.12);padding:8px}
.eta{margin-top:8px;font-weight:800}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:70px;background:#0b1220;color:#e5e7eb;border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:12px;font-size:12px;display:none;z-index:120}
.error{position:fixed;top:56px;left:0;right:0;background:#7f1d1d;color:#fff;padding:10px 14px;font-size:12px;display:none;z-index:60;text-align:center}
.small{font-size:12px;color:var(--muted);margin-left:8px}
.leaflet-control-layers-expanded{background:#0b1220;color:#e5e7eb;border:1px solid rgba(255,255,255,.12);border-radius:12px}
.leaflet-control-scale-line{background:#0b1220;color:#e5e7eb;border:1px solid rgba(255,255,255,.12)}
</style>

<!-- Leaflet å¤š CDN é€€é¿ -->
<link id="leaflet-css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script>
(function(){
  const cdns=[
    "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js",
    "https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js",
    "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  ];
  let i=0;
  function tryLoad(){
    if(i>=cdns.length){document.addEventListener('DOMContentLoaded',()=>{const e=document.getElementById('errorbar');e.textContent='Leaflet ä»ç„¡æ³•è¼‰å…¥ï¼ˆå¯èƒ½è¢«ç¶²è·¯æˆ– CDN é˜»æ“‹ï¼‰ã€‚';e.style.display='block';});return;}
    const s=document.createElement('script'); s.src=cdns[i++]; s.async=true;
    s.onload=()=>document.dispatchEvent(new Event('leaflet:ready'));
    s.onerror=tryLoad; document.head.appendChild(s);
  } tryLoad();
})();
</script>
</head>
<body>
<header>
  <div class="head">
    <div>
      <div class="title">æ›¼è°·è¡Œç¨‹ï½œå…§åµŒå°èˆªï¼ˆç„¡é‡‘é‘°ï¼‰</div>
      <div class="sub">å³æ™‚å®šä½ï¼‹å…§åµŒåœ°åœ–ï¼›é–‹è»Š/æ­¥è¡Œå…§ç®—ï¼ˆOSRMï¼‰ï¼›<b>å¤§çœ¾é‹è¼¸å¤–é–‹ Google</b></div>
    </div>
    <div style="margin-left:auto" class="small">æç¤ºï¼šiPhone è¨­å®šè¦é–‹ã€Œç²¾ç¢ºä½ç½®ã€ä»¥æé«˜ç²¾åº¦</div>
  </div>
  <div class="tabs" role="tablist" aria-label="Days">
    <button class="tab" id="tab-1" aria-selected="true">Day 1ï½œ9/26 (äº”)</button>
    <button class="tab" id="tab-2">Day 2ï½œ9/27 (å…­)</button>
    <button class="tab" id="tab-3">Day 3ï½œ9/28 (æ—¥)</button>
    <button class="tab" id="tab-4">Day 4ï½œ9/29 (ä¸€)</button>
  </div>
  <div class="bar">
    <select id="mode" class="select">
      <option value="driving" selected>é–‹è»Šï¼ˆå…§ç®—ï¼‰</option>
      <option value="foot">æ­¥è¡Œï¼ˆå…§ç®—ï¼‰</option>
      <option value="transit">å¤§çœ¾é‹è¼¸ï¼ˆå¤–é–‹ Googleï¼‰</option>
    </select>
    <button class="btn" id="btnFollow">ğŸ›° è·Ÿéš¨æˆ‘ï¼šé–‹</button>
    <button class="btn ghost" id="btnPrecise">ğŸ¯ ç²¾æº–æ¨¡å¼ï¼šé–‹</button>
    <button class="btn ghost" id="btnRecenter">å›åˆ°æˆ‘çš„ä½ç½®</button>
    <button class="btn ghost" id="btnStop">åœæ­¢å°èˆª</button>
    <button class="btn ghost" id="btnShare">åˆ†äº«æ•´ä»½è¡Œç¨‹</button>
  </div>
</header>

<div class="container">
  <div class="grid">
    <div id="itins"></div>
    <div>
      <div id="map" class="card" aria-label="åœ°åœ–"></div>
      <div class="card eta" id="etaBox">å°šæœªé–‹å§‹å°èˆª</div>
      <div id="panel" class="card"></div>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>
<div class="error" id="errorbar"></div>

<script>
/* ====== è¡Œç¨‹ï¼ˆDay4 å·²æ‹†ï¼šBig C / æš¹ç¾…å»£å ´ï¼‰ ====== */
const DEFAULT_DAYS=[
 {id:1,label:'Day 1ï½œ9/26 (äº”)',chips:['Asokï½œErawan','Chula','æŒ‰æ‘©'],stops:[
  {time:'13:00â€“14:00',title:'Terminal 21 è³¼ç‰©',q:'Terminal 21 Asok'},
  {time:'14:30â€“15:00',title:'å››é¢ä½› åƒæ‹œ',q:'Erawan Shrine Bangkok'},
  {time:'15:00â€“16:30',title:'æœ±æ‹‰éš†åŠŸå¤§å­¸ æ ¡åœ’å·¡ç¦®',q:'Chulalongkorn University'},
  {time:'16:30â€“18:00',title:'Chula å•†åœˆï¼ˆç­é€šè·¯ / Jay Ohï¼‰',q:'Banthat Thong Road Bangkok'},
  {time:'18:00â€“19:30',title:'Big C é€›è¡—',q:'Big C Ratchadamri'},
  {time:'20:00â€“21:30',title:'Massage@Le æŒ‰æ‘©',q:'Massage@Le Bangkok'}
 ]},
 {id:2,label:'Day 2ï½œ9/27 (å…­)',chips:['èˆŠåŸå¯ºå»Ÿç¾¤','æ²³ç•”','ICONSIAM'],stops:[
  {time:'09:30â€“12:00',title:'å¤§çš‡å®®ï¼ç‰ä½›å¯ºï¼è‡¥ä½›å¯ºï¼ç‘ªå“ˆæ³°å¯º å·¡ç¦®',q:'Grand Palace Bangkok'},
  {time:'12:00â€“13:00',title:'Tha Maharaj ç”¨é¤ä¼‘æ¯',q:'Tha Maharaj'},
  {time:'13:30â€“15:00',title:'è€ƒå±±è·¯ é–’æ™ƒï¼ˆç‰¹è‰²æ˜Ÿå·´å…‹ï¼‰',q:'Khaosan Road'},
  {time:'16:00â€“17:00',title:'é„­ç‹å»Ÿï¼ˆç‹æœ—å¸‚å ´ï¼‰',q:'Wat Arun Ratchawararam'},
  {time:'18:00â€“19:30',title:'ICONSIAM é€›è¡—',q:'ICONSIAM'},
  {time:'19:45â€“21:45',title:'ç™½è˜­èŠ±è™Ÿ æ™šé¤éŠèˆ¹',q:'White Orchid River Cruise Bangkok'}
 ]},
 {id:3,label:'Day 3ï½œ9/28 (æ—¥)',chips:['éƒŠå€åŒ…è»Š','å¸‚é›†','Spa'],stops:[
  {time:'07:00â€“13:30',title:'ä¸¹å«©æ²™æœµï¼ç¾åŠŸéµé“ï¼æ¨¹ä¸­å»Ÿï¼ˆåŒ…è»Šï¼‰',q:'Damnoen Saduak Floating Market'},
  {time:'15:00â€“17:00',title:'æ´½åœ–æ´½å¸‚é›†ï¼ˆJJ Mallï¼‰',q:'Chatuchak Weekend Market'},
  {time:'17:00â€“18:20',title:'å–¬å¾·å¤œå¸‚ï¼ˆç«å±±æ’éª¨ï¼‰',q:'Jodd Fairs Rama 9 Bangkok'},
  {time:'19:00â€“21:00',title:'Oasis æ°´ç™‚æŒ‰æ‘©',q:'Oasis Spa Bangkok'}
 ]},
 {id:4,label:'Day 4ï½œ9/29 (ä¸€)',chips:['Buffet','Siam å€'],stops:[
  {time:'10:00â€“12:00',title:'æš¹ç¾…ç™¾éº—å®® Buffetï¼ˆWISDOMï¼‰',q:'Siam Paragon'},
  {time:'12:00â€“13:00',title:'Big C é€›è¡—',q:'Big C Ratchadamri'},
  {time:'13:00â€“14:00',title:'æš¹ç¾…å»£å ´ é€›è¡—',q:'Siam Square'}
 ]}
];
const LS_KEY='itinerary_osrm_v2_splitday4'; // æ²¿ç”¨ä½ çš„ keyï¼Œä¿ç•™æœ¬åœ°è³‡æ–™
function loadDays(){try{const r=localStorage.getItem(LS_KEY);return r?JSON.parse(r):null;}catch{return null}}
function saveDays(d){localStorage.setItem(LS_KEY,JSON.stringify(d))}
let days=loadDays()||JSON.parse(JSON.stringify(DEFAULT_DAYS)); saveDays(days);

/* ====== å°å·¥å…· ====== */
const errorbar=document.getElementById('errorbar');
const toast=document.getElementById('toast');
const itinsEl=document.getElementById('itins');
const panelEl=document.getElementById('panel');
const etaBox=document.getElementById('etaBox');
function showError(m){errorbar.textContent=m;errorbar.style.display='block';}
function showToast(m){toast.textContent=m;toast.style.display='block';setTimeout(()=>toast.style.display='none',1800);}
function encodeQ(q){return encodeURIComponent(q||'');}
function isLatLng(q){const m=q.match?.(/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/);return m?{lat:+m[1],lng:+m[2]}:null}
function gmapsDirURL(originLL,destQ,mode){const s=originLL?`&origin=${encodeURIComponent(originLL.lat+','+originLL.lng)}`:'';return `https://www.google.com/maps/dir/?api=1${s}&destination=${encodeURIComponent(destQ)}&travelmode=${mode}`}

/* ====== UI æ¸²æŸ“ ====== */
function card(stop,idx,dayId){
  const g=`https://www.google.com/maps/search/?api=1&query=${encodeQ(stop.q)}`;
  return `<div class="card">
    <div class="row"><div class="time">${stop.time||''}</div><div class="place">${stop.title||''}</div></div>
    <div class="actions">
      <a class="action" target="_blank" href="${g}">ğŸ—ºï¸ æŸ¥çœ‹åœ°é»</a>
      <button class="action secondary" data-nav="${encodeQ(stop.q)}">â–¶ï¸ é–‹å§‹å°èˆª</button>
      <button class="action" data-del="${dayId},${idx}">ğŸ—‘ï¸ åˆªé™¤</button>
    </div>
  </div>`;
}
function renderList(){
  itinsEl.innerHTML='';
  days.forEach(d=>{
    const chips=(d.chips||[]).map(c=>`<span class="pill">${c}</span>`).join(' ');
    const rows=(d.stops||[]).map((s,i)=>card(s,i,d.id)).join('');
    const sec=document.createElement('section');
    sec.id=`panel-${d.id}`;sec.setAttribute('role','tabpanel');sec.hidden=d.id!==1;
    sec.innerHTML=`<div class="card"><div class="row"><div class="place">${d.label}</div><div>${chips}</div></div>
      <div class="note">é–‹è»Š/æ­¥è¡Œå…§ç®—ï¼›<b>å¤§çœ¾é‹è¼¸æœƒç›´æ¥å¤–é–‹ Google åœ°åœ–</b>ã€‚</div></div>
      ${rows}
      <div class="card"><div class="actions">
        <button class="action" data-add="${d.id}">ï¼‹æ–°å¢ç«™é»</button>
        <button class="action secondary" data-goall="${d.id}">ä¾åºé€ è¨ªï¼ˆå¤–é–‹ Googleï¼‰</button>
      </div></div>`;
    itinsEl.appendChild(sec);
  });
}
renderList();

/* Tabs */
document.addEventListener('click',(e)=>{
  if(e.target.matches('.tab')){
    const id=Number(e.target.id.split('-')[1]);
    document.querySelectorAll('[role="tabpanel"]').forEach(p=>p.hidden=true);
    document.getElementById(`panel-${id}`).hidden=false;
    document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false'));
    e.target.setAttribute('aria-selected','true');
    window.scrollTo({top:0,behavior:'smooth'});
  }
});

/* ====== Leaflet åœ°åœ–ï¼‹å¤šåœ–å±¤ ====== */
let map, baseLayers, myMarker, accCircle, routeLine;
let watchId=null, originLL=null, destLL=null, lastFix=null, lastRouteAt=0;
let followMe=true, preciseMode=true; // æ–°å¢

document.addEventListener('leaflet:ready',()=>{ initMap(); startWatch(); });

function initMap(){
  map=L.map('map');

  // å¤šåº•åœ–ï¼ˆå«è¡›æ˜Ÿèˆ‡è¡›æ˜Ÿæ··åˆï¼‰
  const osmStd = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'});
  const osmHOT = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap, HOT'});
  const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:20,attribution:'&copy; OpenStreetMap & CARTO'});
  const cartoDark  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:20,attribution:'&copy; OpenStreetMap & CARTO'});
  const cartoVoy   = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{maxZoom:20,attribution:'&copy; OpenStreetMap & CARTO'});
  // Esri è¡›æ˜Ÿ + æ¨™ç±¤ï¼ˆæ··åˆï¼‰
  const esriSat   = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19,attribution:'Tiles &copy; Esri'});
  const esriLabel = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',{maxZoom:19,attribution:'&copy; Esri'});
  const esriHybrid = L.layerGroup([esriSat, esriLabel]);

  baseLayers = {
    'OSM æ¨™æº–': osmStd,
    'OSM Humanitarian': osmHOT,
    'CARTO Light': cartoLight,
    'CARTO Dark': cartoDark,
    'CARTO Voyager': cartoVoy,
    'è¡›æ˜Ÿåœ–ï¼ˆEsriï¼‰': esriSat,
    'è¡›æ˜Ÿæ··åˆï¼ˆEsri+æ¨™ç±¤ï¼‰': esriHybrid
  };
  cartoVoy.addTo(map); // é è¨­æ¯”è¼ƒå¥½çœ‹
  L.control.layers(baseLayers,null,{collapsed:false}).addTo(map);
  L.control.scale({metric:true,imperial:false}).addTo(map);
  map.setView([13.7563,100.5018],12);
}

/* ====== å®šä½ï¼ˆç²¾æº–æ¨¡å¼ + å¹³æ»‘ + è·Ÿéš¨ï¼‰ ====== */
document.getElementById('btnFollow').addEventListener('click',()=>{
  followMe=!followMe;
  document.getElementById('btnFollow').textContent=followMe?'ğŸ›° è·Ÿéš¨æˆ‘ï¼šé–‹':'ğŸ›° è·Ÿéš¨æˆ‘ï¼šé—œ';
});
document.getElementById('btnPrecise').addEventListener('click',()=>{
  preciseMode=!preciseMode;
  document.getElementById('btnPrecise').textContent=preciseMode?'ğŸ¯ ç²¾æº–æ¨¡å¼ï¼šé–‹':'ğŸ¯ ç²¾æº–æ¨¡å¼ï¼šé—œ';
  showToast(preciseMode?'å°‡å¿½ç•¥ç²¾åº¦ > 50m çš„å®šä½':'å°‡æ¥å—æ‰€æœ‰å®šä½ï¼ˆå¯èƒ½è¼ƒé£„ï¼‰');
});

function startWatch(){
  if(!('geolocation' in navigator)){showError('æ­¤è£ç½®ä¸æ”¯æ´å®šä½');return;}
  const opts={enableHighAccuracy:true,maximumAge:0,timeout:15000};
  watchId=navigator.geolocation.watchPosition(pos=>{
    let {latitude,longitude,accuracy} = pos.coords;

    // ç²¾æº–æ¨¡å¼ï¼šå¿½ç•¥å¤ªå·®çš„å®šä½
    if(preciseMode && accuracy>50){ 
      showToast(`ç­‰å¾…æ›´ç²¾æº–å®šä½ï¼ˆç›®å‰ ~${Math.round(accuracy)}mï¼‰`); 
      return; 
    }

    // ä½ç½®å¹³æ»‘ï¼ˆç°¡å–® EMAï¼‰
    const alpha=0.3;
    if(lastFix){
      latitude  = alpha*latitude  + (1-alpha)*lastFix.lat;
      longitude = alpha*longitude + (1-alpha)*lastFix.lng;
    }
    const ll=[latitude,longitude];
    const here={lat:latitude,lng:longitude};

    if(!myMarker){
      myMarker=L.marker(ll).addTo(map).bindTooltip('æˆ‘',{permanent:false});
      accCircle=L.circle(ll,{radius:Math.max(accuracy,15),color:'#22c55e',fillColor:'#22c55e',fillOpacity:.08,weight:1}).addTo(map);
      map.panTo(ll);
    }else{
      myMarker.setLatLng(ll); accCircle.setLatLng(ll); accCircle.setRadius(Math.max(accuracy,15));
      if(followMe){ map.setView(ll, map.getZoom(), {animate:false}); }
    }
    originLL=here;
    const now=Date.now();
    if(destLL && (distance(lastFix||here, here)>30 || now-lastRouteAt>10000)) recalcRoute();
    lastFix=here;
  },err=>{console.warn(err);showToast('å®šä½æš«æ™‚å¤±æ•—ï¼ŒæœƒæŒçºŒå˜—è©¦â€¦');},opts);
}
document.getElementById('btnRecenter').addEventListener('click',()=>{ if(myMarker) map.panTo(myMarker.getLatLng()); });
document.getElementById('btnStop').addEventListener('click',stopNav);
function stopNav(){
  destLL=null; if(routeLine){map.removeLayer(routeLine);routeLine=null;}
  etaBox.textContent='å°šæœªé–‹å§‹å°èˆª'; panelEl.innerHTML='';
}

/* ====== OSRMï¼š/nearest è²¼é½Šé“è·¯ + /route ====== */
async function osrmNearest(profile, p){
  const url=`https://router.project-osrm.org/nearest/v1/${profile}/${p.lng},${p.lat}`;
  const r=await fetch(url); if(!r.ok) throw new Error('nearest å¤±æ•—');
  const j=await r.json(); const c=j?.waypoints?.[0]?.location; 
  return c?{lng:c[0],lat:c[1]}:p;
}
async function osrmRoute(profile, coords){
  const path=coords.map(c=>`${c.lng},${c.lat}`).join(';');
  const url=`https://router.project-osrm.org/route/v1/${profile}/${path}?overview=full&geometries=geojson&steps=true`;
  const res=await fetch(url,{headers:{'Accept':'application/json'}});
  if(!res.ok) throw new Error('OSRM é€£ç·šå¤±æ•—');
  const data=await res.json();
  if(!data.routes||!data.routes[0]) throw new Error('æ‰¾ä¸åˆ°è·¯ç·š');
  return data.routes[0];
}
function minutes(s){return `${Math.round(s/60)} åˆ†é˜`;}
function kms(m){return (m/1000).toFixed(1)+' å…¬é‡Œ';}
function distance(a,b){const R=6371000,toRad=x=>x*Math.PI/180,dLat=toRad(b.lat-a.lat),dLng=toRad(b.lng-a.lng),s1=Math.sin(dLat/2),s2=Math.sin(dLng/2),h=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;return 2*R*Math.asin(Math.sqrt(h));}

async function recalcRoute(){
  if(!originLL||!destLL) return;
  const sel=document.getElementById('mode').value;
  if(sel==='transit'){
    etaBox.textContent='å¤§çœ¾é‹è¼¸å·²æ”¹ç‚ºå¤–é–‹ Google åœ°åœ–';
    panelEl.innerHTML='<div class="note">è«‹ç›´æ¥ä½¿ç”¨ç«™é»ã€Œé–‹å§‹å°èˆªã€ï¼Œæœƒå¤–é–‹ Googleï¼ˆtransitï¼‰ã€‚</div>';
    return;
  }
  try{
    // èµ·é»è²¼é½Šé“è·¯ï¼ˆç¸®å°è¦–å·®ï¼‰
    const snapped = await osrmNearest(sel, originLL).catch(()=>originLL);
    const route=await osrmRoute(sel, [snapped, destLL]);
    lastRouteAt=Date.now();
    const coords=route.geometry.coordinates.map(([lng,lat])=>[lat,lng]);
    if(routeLine){routeLine.setLatLngs(coords);}else{routeLine=L.polyline(coords,{color:'#22c55e'}).addTo(map);}
    if(!followMe){ map.fitBounds(L.latLngBounds(coords),{padding:[20,20]}); }
    etaBox.textContent=`æ™‚é–“ï¼š${minutes(route.duration)}ï½œè·é›¢ï¼š${kms(route.distance)}`;
    const steps=[];
    route.legs[0].steps.forEach(s=>{
      steps.push(`<li>${s.maneuver.instruction||s.name||''} <span class="small">ï¼ˆ${kms(s.distance)} / ${minutes(s.duration)}ï¼‰</span></li>`);
    });
    const tm = sel==='foot'?'walking':'driving';
    panelEl.innerHTML=`<ol>${steps.join('')}</ol>
      <div class="actions" style="margin-top:10px">
        <a class="action" target="_blank"
          href="${gmapsDirURL(originLL, destLL.lat+','+destLL.lng, tm)}">åœ¨ Google åœ°åœ–é–‹å•Ÿ</a>
      </div>`;
  }catch(e){ etaBox.textContent='è·¯ç·šè¦åŠƒå¤±æ•—ï¼š'+e.message; }
}

/* ====== Geocodingï¼ˆNominatimï¼‰ ====== */
async function geocode(q){
  const direct=isLatLng(q); if(direct) return direct;
  const url=`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeQ(q)}`;
  const res=await fetch(url,{headers:{'Accept':'application/json'}});
  if(!res.ok) throw new Error('åœ°åè§£æå¤±æ•—');
  const arr=await res.json();
  if(!arr[0]) throw new Error('æ‰¾ä¸åˆ°åœ°é»');
  return {lat:+arr[0].lat,lng:+arr[0].lon};
}

/* ====== äº‹ä»¶ï¼šé–‹å§‹å°èˆª / å¤–é–‹æ•´æ—¥ / å¢åˆª ====== */
document.addEventListener('click',async(e)=>{
  if(e.target.dataset.nav){
    const q=decodeURIComponent(e.target.dataset.nav);
    const sel=document.getElementById('mode').value;
    if(sel==='transit'){ // ç›´æ¥å¤–é–‹ Google transit
      const url = gmapsDirURL(originLL, q, 'transit');
      const w=window.open(url,'_blank'); if(!w) location.href=url;
      return;
    }
    try{
      destLL=await geocode(q);
      if(!originLL && lastFix){ originLL=lastFix; }
      if(!originLL){ showToast('ç­‰å¾…å®šä½â€¦'); return; }
      recalcRoute();
    }catch(err){ alert(err.message+'\nå¯æ›å€‹é—œéµå­—ï¼Œæˆ–ç›´æ¥ç”¨ç¶“ç·¯åº¦ "13.7367,100.5231"'); }
  }
  if(e.target.dataset.add){
    const dayId=Number(e.target.dataset.add);
    const time=prompt('æ™‚é–“ï¼ˆ14:00â€“16:00 å¯ç•™ç©ºï¼‰')||'';
    const title=prompt('æ¨™é¡Œ')||'æœªå‘½å';
    const q=prompt('åœ°åæˆ–ç¶“ç·¯åº¦')||'';
    const d=days.find(x=>x.id===dayId); if(!d) return;
    d.stops.push({time,title,q}); saveDays(days); renderList(); showToast('å·²æ–°å¢');
  }
  if(e.target.dataset.del){
    const [dayId,idx]=e.target.dataset.del.split(',').map(Number);
    const d=days.find(x=>x.id===dayId); if(!d||!d.stops[idx]) return;
    d.stops.splice(idx,1); saveDays(days); renderList(); showToast('å·²åˆªé™¤');
  }
  if(e.target.dataset.goall){
    const id=Number(e.target.dataset.goall);
    const d=days.find(x=>x.id===id); if(!d) return;
    const wp=d.stops.slice(0,-1).map(s=>s.q);
    const dest=d.stops[d.stops.length-1]?.q||'';
    const sel=document.getElementById('mode').value;
    const tm = sel==='foot'?'walking' : sel==='transit'?'transit':'driving';
    const saddr = originLL ? `${originLL.lat},${originLL.lng}` : '';
    const url=`https://www.google.com/maps/dir/?api=1${saddr?`&origin=${encodeURIComponent(saddr)}`:''}&destination=${encodeURIComponent(dest)}${wp.length?`&waypoints=${encodeURIComponent(wp.join('|'))}`:''}&travelmode=${tm}`;
    const w=window.open(url,'_blank'); if(!w) location.href=url;
  }
});

// åˆ†äº«æ•´ä»½è¡Œç¨‹ï¼ˆURL å…§åµŒï¼‰
document.getElementById('btnShare').addEventListener('click',async()=>{
  const b64=btoa(unescape(encodeURIComponent(JSON.stringify(days))));
  const url=`${location.origin}${location.pathname}?data=${b64}`;
  try{ if(navigator.share){ await navigator.share({title:'æˆ‘çš„è¡Œç¨‹',url}); }
       else if(navigator.clipboard){ await navigator.clipboard.writeText(url); showToast('å·²è¤‡è£½åˆ†äº«é€£çµ'); }
       else { prompt('è¤‡è£½é€™å€‹é€£çµï¼š',url); } }catch{ prompt('è¤‡è£½é€™å€‹é€£çµï¼š',url); }
});
(function importFromURL(){
  const qs=new URLSearchParams(location.search); const d=qs.get('data');
  if(!d) return;
  try{ const json=decodeURIComponent(escape(atob(d))); const obj=JSON.parse(json);
    if(Array.isArray(obj)&&obj.length){ days=obj; saveDays(days); history.replaceState(null,'',location.pathname); renderList(); }
  }catch{}
})();
</script>
</body>
</html>
