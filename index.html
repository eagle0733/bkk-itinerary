<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="theme-color" content="#0f172a"/>
  <title>æ›¼è°·è¡Œç¨‹ PWAï¼ˆLeaflet | ç„¡é‡‘é‘°/ç„¡ Google APIï¼‰</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="./icon-512.png">
  <!-- Leafletï¼ˆç„¡éœ€ API Keyï¼‰ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-VuZ8H8bN6Z9erjRzCQXDpUe1koXSPoZ1G7G8KPVWJJ8=" crossorigin=""></script>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --chip:#1f2937; --btn:#16a34a; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif}
    .container{max-width:960px;margin:0 auto;padding:16px 16px 88px}
    header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.75));backdrop-filter:blur(8px);border-bottom:1px solid rgba(148,163,184,.15)}
    .head-inner{display:flex;gap:12px;align-items:center;padding:12px 16px}
    .title{font-size:18px;font-weight:700}
    .sub{font-size:12px;color:var(--muted)}
    .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:8px 16px}
    .tab{padding:10px;border-radius:12px;background:var(--chip);color:var(--text);text-align:center;font-weight:700;border:1px solid rgba(255,255,255,.08);cursor:pointer}
    .tab[aria-selected="true"]{background:var(--btn);border-color:transparent}
    .controls{display:flex;gap:8px;flex-wrap:wrap;padding:8px 16px 12px}
    .select,.btn{border:none;border-radius:12px;padding:10px 12px;font-weight:600}
    .select{background:var(--chip);color:var(--text)}
    .btn{background:var(--btn);color:white;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;margin:10px 0}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .time{font-weight:800;letter-spacing:.2px;min-width:86px}
    .place{font-weight:700}
    .note{color:var(--muted);font-size:12px;margin-top:4px}
    .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .action{flex:1;background:#0b5b2f;color:white;border-radius:12px;border:1px solid rgba(255,255,255,.12);padding:10px 12px;text-align:center;font-weight:700;cursor:pointer}
    .action.secondary{background:#0f766e}
    .route-card{background:#0b1220;border-radius:16px;border:1px dashed rgba(148,163,184,.25);padding:12px;margin-top:14px}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#0b1220;border:1px solid rgba(255,255,255,.1);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .grid{display:grid;gap:10px}
    @media (min-width:720px){ .grid{grid-template-columns:1fr 1fr} }
    #map{height:56vh;border-radius:12px;border:1px solid rgba(255,255,255,.12);margin-top:10px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:70px;background:#0b1220;color:#e5e7eb;border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:12px;font-size:12px;display:none;z-index:120}
  </style>
</head>
<body>
  <header>
    <div class="head-inner">
      <div>
        <div class="title">æ›¼è°·è¡Œç¨‹ PWAï¼ˆLeaflet ç‰ˆï½œç„¡é‡‘é‘°ï¼‰</div>
        <div class="sub">ä½¿ç”¨ OpenStreetMap åœ–ç£šèˆ‡ç€è¦½å™¨å®šä½ï¼›å…§å»ºç°¡æ˜“ç›´ç·šå°èˆªï¼‹å¤–é–‹ Apple/Google/OSM è·¯ç·š</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="btn ghost" id="btnInstall" title="å®‰è£ç‚º App">ğŸ“² å®‰è£</button>
      </div>
    </div>
    <div class="tabs" role="tablist" aria-label="Days">
      <button class="tab" role="tab" id="tab-1" aria-controls="panel-1" aria-selected="true">Day 1ï½œ9/26 (äº”)</button>
      <button class="tab" role="tab" id="tab-2" aria-controls="panel-2" aria-selected="false">Day 2ï½œ9/27 (å…­)</button>
      <button class="tab" role="tab" id="tab-3" aria-controls="panel-3" aria-selected="false">Day 3ï½œ9/28 (æ—¥)</button>
      <button class="tab" role="tab" id="tab-4" aria-controls="panel-4" aria-selected="false">Day 4ï½œ9/29 (ä¸€)</button>
    </div>
    <div class="controls">
      <select id="travelMode" class="select" aria-label="å°èˆªæ¨¡å¼">
        <option value="walk">æ­¥è¡Œï¼ˆå¤–é–‹ï¼‰</option>
        <option value="drive">é–‹è»Šï¼ˆå¤–é–‹ï¼‰</option>
      </select>
      <button class="btn" id="btnTodayRoute">ğŸ—ºï¸ å¾æˆ‘é€™è£¡ä¸²èµ·ä»Šæ—¥è·¯ç·š</button>
      <button class="btn ghost" id="btnRecenter">ğŸ¯ å›åˆ°æˆ‘çš„ä½ç½®</button>
      <button class="btn ghost" id="btnFollow">ğŸ”” é–‹å•Ÿç›´ç·šå°èˆª</button>
    </div>
  </header>

  <main class="container">
    <div id="panels"></div>
    <div id="map"></div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
  // ====== è¡Œç¨‹è³‡æ–™ï¼ˆåŒå‰ç‰ˆï¼Œéæ¿¾ç´”äº¤é€šæ®µï¼‰ ======
  const DEFAULT_DAYS = [
    {
      id: 1, label: 'Day 1ï½œ9/26 (äº”)', chips: ['Asokï½œErawan', 'Chula', 'æŒ‰æ‘©'],
      stops: [
        { time: '13:00â€“14:00', title: 'Terminal 21 è³¼ç‰©', q: 'Terminal 21 Asok', note: '' },
        { time: '14:30â€“15:00', title: 'å››é¢ä½› åƒæ‹œ', q: 'Erawan Shrine Bangkok', note: 'å¯çŸ­æš«åƒè§€' },
        { time: '15:00â€“16:30', title: 'æœ±æ‹‰éš†åŠŸå¤§å­¸ æ ¡åœ’å·¡ç¦®', q: 'Chulalongkorn University', note: 'æ ¡åœ’èµ°èµ°' },
        { time: '16:30â€“18:00', title: 'Chula å•†åœˆï¼ˆç­é€šè·¯ / Jay Ohï¼‰', q: 'Banthat Thong Road Bangkok', note: 'å¯åƒ Jay Oh Chula' },
        { time: '18:00â€“19:30', title: 'Big Cï¼æš¹ç¾…å»£å ´ é€›è¡—', q: 'Big C Ratchadamri or Siam Square', note: '' },
        { time: '20:00â€“21:30', title: 'Massage@Le æŒ‰æ‘©', q: 'Massage@Le Bangkok', note: 'æ”¾é¬†' }
      ]
    },
    { id: 2, label: 'Day 2ï½œ9/27 (å…­)', chips: ['èˆŠåŸå¯ºå»Ÿç¾¤', 'æ²³ç•”', 'ICONSIAM'], stops: [
      { time: '09:30â€“12:00', title: 'å¤§çš‡å®®ï¼ç‰ä½›å¯ºï¼è‡¥ä½›å¯ºï¼ç‘ªå“ˆæ³°å¯º å·¡ç¦®', q: 'Grand Palace Bangkok', note: 'åŒå€æ­¥è¡Œå¯é”' },
      { time: '12:00â€“13:00', title: 'Tha Maharaj ç”¨é¤ä¼‘æ¯', q: 'Tha Maharaj', note: '' },
      { time: '13:30â€“15:00', title: 'è€ƒå±±è·¯ é–’æ™ƒï¼ˆç‰¹è‰²æ˜Ÿå·´å…‹ï¼‰', q: 'Khaosan Road', note: '' },
      { time: '16:00â€“17:00', title: 'é„­ç‹å»Ÿï¼ˆç‹æœ—å¸‚å ´ï¼‰', q: 'Wat Arun Ratchawararam', note: 'å¯é †é€› Wang Lang Market' },
      { time: '18:00â€“19:30', title: 'ICONSIAM é€›è¡—', q: 'ICONSIAM', note: '' },
      { time: '19:45â€“21:45', title: 'ç™½è˜­èŠ±è™Ÿ æ™šé¤éŠèˆ¹', q: 'White Orchid River Cruise Bangkok', note: '' }
    ]},
    { id: 3, label: 'Day 3ï½œ9/28 (æ—¥)', chips: ['éƒŠå€åŒ…è»Š', 'å¸‚é›†', 'Spa'], stops: [
      { time: '07:00â€“13:30', title: 'ä¸¹å«©æ²™æœµï¼ç¾åŠŸéµé“ï¼æ¨¹ä¸­å»Ÿï¼ˆåŒ…è»Šï¼‰', q: 'Damnoen Saduak Floating Market', note: 'å« Maeklong Railway Marketã€Wat Bang Kung' },
      { time: '15:00â€“17:00', title: 'æ´½åœ–æ´½å¸‚é›†ï¼ˆJJ Mallï¼‰', q: 'Chatuchak Weekend Market', note: '' },
      { time: '17:00â€“18:20', title: 'å–¬å¾·å¤œå¸‚ï¼ˆç«å±±æ’éª¨ï¼‰', q: 'Jodd Fairs Rama 9 Bangkok', note: '' },
      { time: '19:00â€“21:00', title: 'Oasis æ°´ç™‚æŒ‰æ‘©', q: 'Oasis Spa Bangkok', note: 'å°±è¿‘åˆ†åº—' }
    ]},
    { id: 4, label: 'Day 4ï½œ9/29 (ä¸€)', chips: ['Buffet', 'Siam å€'], stops: [
      { time: '10:00â€“12:00', title: 'æš¹ç¾…ç™¾éº—å®® Buffetï¼ˆWISDOMï¼‰', q: 'Siam Paragon', note: 'WISDOM International Buffet' },
      { time: '12:00â€“14:00', title: 'Big Cï¼æš¹ç¾…å»£å ´ é€›è¡—', q: 'Big C Ratchadamri or Siam Square', note: '' }
    ]}
  ];

  // ====== PWA æ°¸ä¹…ä¿å­˜èˆ‡åˆ†äº« ======
  const LS_KEY='itinerary_leaflet_pwa_v1';
  (function(){ const sp=new URLSearchParams(location.search); if(sp.get('reset')==='1') localStorage.removeItem(LS_KEY); })();
  function ensureValidDays(d){ if(!Array.isArray(d)||!d.length) return null; for(const x of d){ if(!x||!('id'in x)||!Array.isArray(x.stops)) return null; } return d; }
  function loadRaw(){ try{const r=localStorage.getItem(LS_KEY); return r?JSON.parse(r):null;}catch{return null} }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(days)); }
  function tryImportFromURL(){
    const parseOnce=()=>{
      const qs=new URLSearchParams(location.search);
      let e=qs.get('data'); if(!e&&location.hash.startsWith('#d=')) e=location.hash.slice(3);
      if(!e) return false;
      try{ const json=decodeURIComponent(escape(atob(e))); const data=JSON.parse(json);
        if(Array.isArray(data)&&data.length){ localStorage.setItem(LS_KEY, JSON.stringify(data)); history.replaceState(null,'',location.pathname); window.__importedFromURL=true; return true; }
      }catch{}
      return false;
    };
    if(parseOnce()) return; window.addEventListener('pageshow',()=>{ if(parseOnce()) location.reload(); });
  }
  tryImportFromURL();
  let days = ensureValidDays(loadRaw()) || JSON.parse(JSON.stringify(DEFAULT_DAYS)); save();

  // ====== Leaflet åœ°åœ–èˆ‡å®šä½ï¼ˆç„¡ APIï¼‰ ======
  let map = L.map('map', { zoomControl: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
  }).addTo(map);
  map.setView([13.7563, 100.5018], 12);

  let meMarker=null, accCircle=null, legLine=null, routeLine=null, followOn=false;
  const toast=document.getElementById('toast');
  function showToast(t){ toast.textContent=t; toast.style.display='block'; setTimeout(()=>toast.style.display='none', 2200); }

  function startWatch(){
    if(!('geolocation' in navigator)){ showToast('è£ç½®ä¸æ”¯æ´å®šä½'); return; }
    const opts={ enableHighAccuracy:true, maximumAge:0, timeout:15000 };
    navigator.geolocation.watchPosition(handleFix, err=>console.warn(err), opts);
  }
  function handleFix(pos){
    const { latitude, longitude, accuracy } = pos.coords;
    const ll=[latitude, longitude];
    localStorage.setItem('lastOrigin', ll.join(','));

    if(!meMarker){
      meMarker=L.marker(ll).addTo(map).bindTooltip('æˆ‘çš„ä½ç½®',{permanent:false});
      accCircle=L.circle(ll,{radius:Math.max(accuracy,15),color:'#22c55e',fillColor:'#22c55e',fillOpacity:0.08,weight:1}).addTo(map);
      map.panTo(ll);
    }else{
      meMarker.setLatLng(ll);
      accCircle.setLatLng(ll); accCircle.setRadius(Math.max(accuracy,15));
    }

    if(followOn && currentTarget){
      updateLeg(ll, currentTarget);
    }
  }

  // ====== ç›´ç·šå°èˆªï¼ˆç„¡è·¯å¾‘ APIï¼‰ ======
  let currentTarget=null; // [lat,lng]
  function updateLeg(fromLL, toLL){
    const line=[fromLL, toLL];
    if(legLine) legLine.setLatLngs(line);
    else legLine=L.polyline(line, {color:'#22c55e'}).addTo(map);

    const d=hav(fromLL, toLL); // meters
    const b=bearing(fromLL, toLL);
    showToast(`è·é›¢ ${ (d/1000).toFixed(2) } kmï½œæ–¹ä½ ${b.toFixed(0)}Â°`);
  }
  function hav(a,b){ const R=6371000; const toRad=x=>x*Math.PI/180; const dLat=toRad(b[0]-a[0]), dLng=toRad(b[1]-a[1]); const lat1=toRad(a[0]), lat2=toRad(b[0]); const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(h)); }
  function bearing(a,b){ const toRad=x=>x*Math.PI/180, toDeg=x=>x*180/Math.PI; const lat1=toRad(a[0]), lat2=toRad(b[0]); const dLon=toRad(b[1]-a[1]); const y=Math.sin(dLon)*Math.cos(lat2); const x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon); let brng=toDeg(Math.atan2(y,x)); return (brng+360)%360; }

  // ====== UIï¼šæ¸²æŸ“é¢æ¿ ======
  const panels=document.getElementById('panels');
  function encodeQ(q){ return encodeURIComponent(q||''); }
  function placeRow(stop){
    const osmUrl = `https://www.openstreetmap.org/search?query=${encodeQ(stop.q)}`;
    return `<div class="card">
      <div class="row"><div class="time">${stop.time||''}</div><div class="place">${stop.title||''}</div></div>
      ${stop.note?`<div class="note">${stop.note}</div>`:''}
      <div class="actions">
        <a class="action" target="_blank" rel="noopener" href="${osmUrl}">ğŸ—ºï¸ OSM åœ°é»</a>
        <button class="action secondary" data-dest="${encodeQ(stop.q)}">â¡ï¸ å¤–é–‹è·¯ç·š</button>
        <button class="action" data-dest-inline="${encodeQ(stop.q)}">ğŸ§­ ç›´ç·šå°èˆªï¼ˆå…§åµŒï¼‰</button>
      </div>
    </div>`;
  }
  function renderPanels(){
    panels.innerHTML='';
    days.forEach(d=>{
      const chips=(d.chips||[]).map(c=>`<span class="pill">${c}</span>`).join(' ');
      const rows=(d.stops||[]).map(placeRow).join('');
      const sec=document.createElement('section');
      sec.id=`panel-${d.id}`; sec.setAttribute('role','tabpanel'); sec.hidden=d.id!==1;
      sec.innerHTML=`
        <div class="card">
          <div class="row"><div style="font-size:18px;font-weight:800">${d.label}</div><div>${chips}</div></div>
          <div class="note">å…§åµŒç‚ºã€Œç›´ç·šå°å¼•ã€ï¼ˆç„¡ APIï¼‰ï¼Œè‹¥éœ€ç²¾æº–è½‰å½æŒ‡ç¤ºè«‹ä½¿ç”¨å¤–é–‹çš„ Apple/Google/OSM æ–¹æ¡ˆã€‚</div>
        </div>
        <div class="grid">${rows}</div>
        <div class="route-card">
          <div style="font-weight:800;margin-bottom:8px">ğŸ“ ä¸€éµä¸²èµ·ä»Šæ—¥è·¯ç·šï¼ˆå¤–é–‹ï¼‰</div>
          <div class="actions">
            <button class="action" data-day="${d.id}" data-mode="full">ä¾åºé€ è¨ªå„ç«™</button>
            <button class="action secondary" data-day="${d.id}" data-mode="dest">åƒ…å°èˆªè‡³æœ€çµ‚é»</button>
          </div>
        </div>`;
      panels.appendChild(sec);
    });
  }

  // ====== å¤–é–‹è·¯ç·šï¼ˆApple / Google / OSMï¼‰ ======
  function externalNavURL(originLL, destQ, waypoints, mode){
    const saddr = `${originLL[0]},${originLL[1]}`;
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);
    const travel = mode==='walk' ? 'w' : 'd'; // Apple dirflg

    if(isIOS){
      // Apple Maps
      const d = encodeURIComponent(destQ);
      const wp = waypoints && waypoints.length ? `&q=${encodeURIComponent(waypoints.join(' to '))}` : '';
      return `https://maps.apple.com/?saddr=${encodeURIComponent(saddr)}&daddr=${d}&dirflg=${travel}${wp}`;
    }else if(isAndroid){
      // Google Maps App (ç„¡é‡‘é‘°)
      const d = encodeURIComponent(destQ);
      const wp = waypoints && waypoints.length ? `&waypoints=${encodeURIComponent(waypoints.join('|'))}` : '';
      const tm = mode==='walk' ? 'walking' : 'driving';
      return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(saddr)}&destination=${d}${wp}&travelmode=${tm}`;
    }else{
      // OSM ç¶²é ï¼ˆFOSSGIS OSRMï¼‰
      const tm = mode==='walk' ? 'foot' : 'car';
      const points = [saddr].concat(waypoints||[], [destQ]);
      return `https://www.openstreetmap.org/directions?engine=fossgis_osrm_${tm}&route=${encodeURIComponent(points.join(';'))}`;
    }
  }

  // ====== Geocoding by Nominatim (ç‚ºé¿å… APIï¼Œåƒ…ç”¨åˆ° OSM æœå°‹é é–‹å•Ÿï¼›å…§åµŒç›´ç·šå°å¼•æä¾›åº§æ¨™è¼¸å…¥æç¤º) ======
  // æä¾›ç°¡å–®åœ°åâ†’åº§æ¨™è§£æï¼ˆä½¿ç”¨ç€è¦½å™¨å…§å»º geolocation + ä½¿ç”¨è€…å¯èƒ½è¼¸å…¥ç¶“ç·¯åº¦ï¼‰ï¼Œé¿å…å¿…ç„¶ä¾è³´é ç«¯ geocoding APIã€‚
  function parseLatLng(q){
    const m = q && q.match?.(/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/);
    if(m) return [parseFloat(m[1]), parseFloat(m[2])];
    return null;
  }

  // ====== äº‹ä»¶ç¶å®š ======
  document.addEventListener('click',(e)=>{
    if(e.target.matches('.tab')){
      const id=Number(e.target.id.split('-')[1]);
      document.querySelectorAll('[role="tabpanel"]').forEach(p=>p.hidden=true);
      document.getElementById(`panel-${id}`).hidden=false;
      document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false'));
      e.target.setAttribute('aria-selected','true');
    }
    if(e.target.matches('[data-dest-inline]')){
      // ç›´ç·šå°å¼•
      const q=decodeURIComponent(e.target.dataset.destInline);
      const coord = parseLatLng(q);
      if(!coord){ alert('ç›´ç·šå°å¼•åƒ…æ”¯æ´è¼¸å…¥ç¶“ç·¯åº¦ï¼ˆä¾‹å¦‚ 13.7367,100.5231ï¼‰ã€‚å¤–é–‹è·¯ç·šå‰‡å¯ç”¨åœ°åã€‚'); return; }
      currentTarget = coord;
      followOn = true;
      document.getElementById('btnFollow').textContent='ğŸ›‘ åœæ­¢ç›´ç·šå°èˆª';
      if(meMarker) updateLeg(meMarker.getLatLng(), coord);
      map.flyTo(coord, 15);
    }
    if(e.target.matches('.action') && e.target.dataset.day){
      // ä¸€éµå¤–é–‹ï¼ˆä¸²å…¨éƒ¨ï¼‰
      const id=Number(e.target.dataset.day);
      const d=days.find(x=>x.id===id); if(!d) return;
      const mode=document.getElementById('travelMode').value;
      const origin=(meMarker?meMarker.getLatLng():map.getCenter());
      const originLL=[origin.lat, origin.lng];
      const dest=d.stops[d.stops.length-1]?.q||'';
      const waypoints=d.stops.slice(0,-1).map(s=>s.q);
      const url=externalNavURL(originLL, dest, waypoints, mode);
      window.open(url, '_blank');
    }
    if(e.target.matches('.action.secondary') && e.target.dataset.dest){
      // å¤–é–‹å–®ç«™
      const q=decodeURIComponent(e.target.dataset.dest);
      const mode=document.getElementById('travelMode').value;
      const origin=(meMarker?meMarker.getLatLng():map.getCenter());
      const originLL=[origin.lat, origin.lng];
      window.open(externalNavURL(originLL, q, [], mode), '_blank');
    }
  });

  // è·Ÿéš¨ï¼åœæ­¢
  document.getElementById('btnFollow').addEventListener('click',()=>{
    followOn = !followOn;
    document.getElementById('btnFollow').textContent = followOn ? 'ğŸ›‘ åœæ­¢ç›´ç·šå°èˆª' : 'ğŸ”” é–‹å•Ÿç›´ç·šå°èˆª';
    if(!followOn){ currentTarget=null; if(legLine){ map.removeLayer(legLine); legLine=null; } }
  });
  document.getElementById('btnRecenter').addEventListener('click',()=>{ if(meMarker) map.panTo(meMarker.getLatLng()); });
  document.getElementById('btnTodayRoute').addEventListener('click',()=>{
    const current=document.querySelector('[role="tabpanel"]:not([hidden])');
    if(!current) return;
    const id=Number(current.id.split('-')[1]);
    const d=days.find(x=>x.id===id);
    if(!d) return;
    const mode=document.getElementById('travelMode').value;
    const origin=(meMarker?meMarker.getLatLng():map.getCenter());
    const originLL=[origin.lat, origin.lng];
    const dest=d.stops[d.stops.length-1]?.q||'';
    const waypoints=d.stops.slice(0,-1).map(s=>s.q);
    window.open(externalNavURL(originLL, dest, waypoints, mode), '_blank');
  });

  // åˆå§‹æ¸²æŸ“ï¼†å®šä½
  function render(){ panels.innerHTML=''; renderPanels(); }
  render(); startWatch();

  // ====== è¡Œç¨‹ç®¡ç†ï¼ˆèˆ‡å‰ç‰ˆç›¸åŒï¼‰ ======
  // ç°¡åŒ–ï¼šä½¿ç”¨ prompt æ–°å¢ã€åˆªé™¤ï¼›æ”¯æ´åˆ†äº«ã€åŒ¯å…¥ã€åŒ¯å‡º
  // ç®¡ç†æŒ‰éˆ•
  const adminBar=document.createElement('div');
  adminBar.style.position='fixed'; adminBar.style.right='10px'; adminBar.style.bottom='10px';
  adminBar.innerHTML=`
    <button class="btn ghost" id="btnAdd">ï¼‹æ–°å¢ç«™é»</button>
    <button class="btn ghost" id="btnDel">åˆªé™¤ç«™é»</button>
    <button class="btn ghost" id="btnShare">åˆ†äº«é€£çµ</button>
    <button class="btn ghost" id="btnExport">åŒ¯å‡º</button>
    <button class="btn ghost" id="btnImport">åŒ¯å…¥</button>`;
  document.body.appendChild(adminBar);

  document.getElementById('btnAdd').addEventListener('click',()=>{
    const dayId=Number(prompt('æ–°å¢åˆ°ç¬¬å¹¾å¤©ï¼ˆ1-4ï¼‰ï¼Ÿ')); if(!dayId) return;
    const time=prompt('æ™‚é–“ï¼ˆå¦‚ 14:00â€“16:00 æˆ– ä¸‹åˆï¼‰')||'';
    const title=prompt('æ¨™é¡Œ')||'æœªå‘½å';
    const q=prompt('é—œéµå­—æˆ–ç¶“ç·¯åº¦ï¼ˆç›´ç·šå°èˆªéœ€ç¶“ç·¯åº¦ï¼‰')||'';
    const note=prompt('å‚™è¨»ï¼ˆå¯ç•™ç™½ï¼‰')||'';
    const d=days.find(x=>x.id===dayId); if(!d) return alert('æ‰¾ä¸åˆ°æŒ‡å®šå¤©æ•¸');
    d.stops.push({time,title,q,note}); save(); render();
  });
  document.getElementById('btnDel').addEventListener('click',()=>{
    const dayId=Number(prompt('è¦åˆªé™¤å“ªä¸€å¤©ï¼ˆ1-4ï¼‰ï¼Ÿ')); const idx=Number(prompt('åˆªé™¤è©²æ—¥ç¬¬å¹¾å€‹ç«™é»ï¼ˆå¾ 1 é–‹å§‹ï¼‰ï¼Ÿ')); if(!dayId||!idx) return;
    const d=days.find(x=>x.id===dayId); if(!d||!d.stops[idx-1]) return alert('æ‰¾ä¸åˆ°ç«™é»');
    d.stops.splice(idx-1,1); save(); render();
  });
  function makeShareLink(){
    const json=JSON.stringify(days); const b64=btoa(unescape(encodeURIComponent(json)));
    const urlQ=`${location.origin}${location.pathname}?reset=1&v=${Date.now()}&data=${b64}`;
    return (urlQ.length<1800)?urlQ:(`${location.origin}${location.pathname}#d=${b64}`);
  }
  document.getElementById('btnShare').addEventListener('click',async()=>{
    const url=makeShareLink();
    try{ if(navigator.share){ await navigator.share({title:'è¡Œç¨‹é€£çµ',url}); }
      else if(navigator.clipboard){ await navigator.clipboard.writeText(url); showToast('å·²è¤‡è£½åˆ†äº«é€£çµ'); }
      else { prompt('è¤‡è£½é€™å€‹é€£çµåˆ†äº«ï¼š',url); }
    }catch{ prompt('è¤‡è£½é€™å€‹é€£çµåˆ†äº«ï¼š',url); }
  });
  document.getElementById('btnExport').addEventListener('click',()=>{
    const blob=new Blob([JSON.stringify(days,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='itinerary.json'; a.click(); URL.revokeObjectURL(url);
  });
  document.getElementById('btnImport').addEventListener('click',()=>{
    const str=prompt('æŠŠ days é™£åˆ— JSON è²¼ä¸Š'); if(!str) return;
    try{ const incoming=JSON.parse(str); if(Array.isArray(incoming)){ localStorage.setItem(LS_KEY, JSON.stringify(incoming)); location.reload(); } else alert('æ ¼å¼éœ€ç‚ºé™£åˆ—'); }catch{ alert('JSON è§£æå¤±æ•—'); }
  });

  // ====== å®‰è£ï¼ˆA2HSï¼‰èˆ‡ SW ======
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; document.getElementById('btnInstall').style.opacity='1'; });
  document.getElementById('btnInstall').addEventListener('click', async ()=>{
    if(!deferredPrompt) return alert('æ­¤ç€è¦½å™¨æš«ä¸æ”¯æ´å®‰è£æç¤ºã€‚');
    deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null;
  });
  </script>
</body>
</html>